

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pyxccd.utils &mdash; pyxccd  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />

  
      <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            pyxccd
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial_en.html">Pyxccd Tutorial(English)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial_ch.html">Pyxccd指南(Chinese)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/pyxccd.html">Pyxccd API reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pyxccd</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">pyxccd.utils</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pyxccd.utils</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">dt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">os.path</span><span class="w"> </span><span class="kn">import</span> <span class="n">join</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">fields</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">stats</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="c1"># from osgeo import gdal</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rasterio.plot</span><span class="w"> </span><span class="kn">import</span> <span class="n">reshape_as_image</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.app</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaults</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.common</span><span class="w"> </span><span class="kn">import</span> <span class="n">SccdOutput</span><span class="p">,</span> <span class="n">nrtqueue_dt</span><span class="p">,</span> <span class="n">sccd_dt</span><span class="p">,</span> <span class="n">nrtmodel_dt</span><span class="p">,</span> <span class="n">DatasetInfo</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">date</span>


<div class="viewcode-block" id="convert_short_date_to_calendar_date">
<a class="viewcode-back" href="../../api/pyxccd.utils.html#pyxccd.utils.convert_short_date_to_calendar_date">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">convert_short_date_to_calendar_date</span><span class="p">(</span><span class="n">short_date</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">date</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a short date (number of days since a base date) to a calendar date.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    short_date: int</span>
<span class="sd">        The number of days added to a base date (723742) to calculate the calendar date.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    date</span>
<span class="sd">        The corresponding calendar date.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">calendar_date</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">fromordinal</span><span class="p">(</span><span class="mi">723742</span> <span class="o">+</span> <span class="n">short_date</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">calendar_date</span></div>



<div class="viewcode-block" id="rio_loaddata">
<a class="viewcode-back" href="../../api/pyxccd.utils.html#pyxccd.utils.rio_loaddata">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">rio_loaddata</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;load raster dataset as numpy array</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        path of the input raster</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">reshape_as_image</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_block_y">
<a class="viewcode-back" href="../../api/pyxccd.utils.html#pyxccd.utils.get_block_y">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_block_y</span><span class="p">(</span><span class="n">block_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">n_block_x</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;get block pos in y axis (started from 1)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    block_id: int</span>
<span class="sd">        The id of the block to be processed</span>
<span class="sd">    n_block_x: int</span>
<span class="sd">        Total number of blocks at x axis</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        current block id at y axis (start from 1)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">((</span><span class="n">block_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_block_x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span></div>



<div class="viewcode-block" id="get_block_x">
<a class="viewcode-back" href="../../api/pyxccd.utils.html#pyxccd.utils.get_block_x">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_block_x</span><span class="p">(</span><span class="n">block_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">n_block_x</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;get block pos at x axis (started from 1)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    block_id: int</span>
<span class="sd">        The id of the block to be processed</span>
<span class="sd">    n_block_x: int</span>
<span class="sd">        Total number of blocks at x axis</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        current block pos at x axis (start from 1)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">block_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">n_block_x</span> <span class="o">+</span> <span class="mi">1</span></div>



<div class="viewcode-block" id="get_col_index">
<a class="viewcode-back" href="../../api/pyxccd.utils.html#pyxccd.utils.get_col_index">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_col_index</span><span class="p">(</span><span class="n">pos</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">current_block_x</span><span class="p">,</span> <span class="n">block_width</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;get column index in a block</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pos: int</span>
<span class="sd">        The position of a pixel, i.e., i_row * n_cols + i_col + 1</span>
<span class="sd">    n_cols: int</span>
<span class="sd">        The number of columns</span>
<span class="sd">    current_block_x: int</span>
<span class="sd">        The current block id at y axis</span>
<span class="sd">    block_width: int</span>
<span class="sd">        block width</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">((</span><span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">n_cols</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">current_block_x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">block_width</span></div>



<div class="viewcode-block" id="get_row_index">
<a class="viewcode-back" href="../../api/pyxccd.utils.html#pyxccd.utils.get_row_index">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_row_index</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">current_block_y</span><span class="p">,</span> <span class="n">block_height</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pos: int</span>
<span class="sd">        The position of a pixel, i.e., i_row * n_cols + i_col + 1</span>
<span class="sd">    n_cols: int</span>
<span class="sd">        The number of columns</span>
<span class="sd">    current_block_y: int</span>
<span class="sd">        The current block id at y axis</span>
<span class="sd">    block_height: int</span>
<span class="sd">        block height</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">((</span><span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_cols</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">current_block_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">block_height</span></div>



<div class="viewcode-block" id="assemble_cmmaps">
<a class="viewcode-back" href="../../api/pyxccd.utils.html#pyxccd.utils.assemble_cmmaps">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">assemble_cmmaps</span><span class="p">(</span>
    <span class="n">dataset_info</span><span class="p">:</span> <span class="n">DatasetInfo</span><span class="p">,</span>
    <span class="n">result_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">cmmap_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">starting_date</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">n_cm_maps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">cm_output_interval</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">clean</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;reorganized block-based change magnitudes into a series of maps</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    config: dict</span>
<span class="sd">        pyxccd config dict</span>
<span class="sd">    result_path: str</span>
<span class="sd">        the path where block-based CM intermediate files are</span>
<span class="sd">    cmmap_path: str</span>
<span class="sd">        the path to save the new map-based output</span>
<span class="sd">    starting_date: int</span>
<span class="sd">        the starting date of the dataset</span>
<span class="sd">    n_cm_maps: int</span>
<span class="sd">        the number of change magnitude outputted per pixel</span>
<span class="sd">    prefix: str</span>
<span class="sd">        choose from &#39;CM&#39;, &#39;CM_date&#39;, &#39;CM_direction&#39;</span>
<span class="sd">    clean: bool</span>
<span class="sd">        if True, clean tmp files</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># anchor_dates_list = None</span>
    <span class="k">if</span> <span class="n">prefix</span> <span class="o">==</span> <span class="s2">&quot;CM&quot;</span><span class="p">:</span>
        <span class="n">output_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span>  <span class="c1"># type: ignore</span>
    <span class="k">elif</span> <span class="n">prefix</span> <span class="o">==</span> <span class="s2">&quot;CM_date&quot;</span><span class="p">:</span>
        <span class="n">output_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span>  <span class="c1"># type: ignore</span>
        <span class="c1"># cuz the date is produced as byte to squeeze the storage size, need to expand</span>
        <span class="c1"># anchor_dates_list_single = np.arange(start=starting_date,</span>
        <span class="c1">#                                      stop=starting_date + config[&#39;CM_OUTPUT_INTERVAL&#39;] * n_cm_maps,</span>
        <span class="c1">#                                      step=config[&#39;CM_OUTPUT_INTERVAL&#39;])</span>
        <span class="c1"># anchor_dates_list = np.tile(anchor_dates_list_single, config[&#39;block_width&#39;] * config[&#39;block_height&#39;])</span>

    <span class="k">elif</span> <span class="n">prefix</span> <span class="o">==</span> <span class="s2">&quot;CM_direction&quot;</span><span class="p">:</span>
        <span class="n">output_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span>  <span class="c1"># type: ignore</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;prefix has been among CM, CM_direction, CM_direction&quot;</span><span class="p">)</span>

    <span class="n">cm_map_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
            <span class="p">(</span><span class="n">dataset_info</span><span class="o">.</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span><span class="p">),</span>
            <span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;COMMON&quot;</span><span class="p">][</span><span class="s2">&quot;NAN_VAL&quot;</span><span class="p">],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">output_type</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cm_maps</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">iblock</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dataset_info</span><span class="o">.</span><span class="n">nblocks</span><span class="p">):</span>
        <span class="n">current_block_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">iblock</span> <span class="o">/</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_x</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">current_block_x</span> <span class="o">=</span> <span class="n">iblock</span> <span class="o">%</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_y</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cm_block</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                <span class="n">join</span><span class="p">(</span>
                    <span class="n">result_path</span><span class="p">,</span>
                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_x</span><span class="si">{}</span><span class="s2">_y</span><span class="si">{}</span><span class="s2">.npy&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">current_block_x</span><span class="p">,</span> <span class="n">current_block_y</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">output_type</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reading CM files fails: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="c1">#    continue</span>

        <span class="c1"># if prefix == &quot;CM_date&quot;:</span>
        <span class="c1">#    cm_block_copy = cm_block.copy()</span>
        <span class="c1">#    cm_block = cm_block + defaults[&quot;COMMON&quot;][&quot;JULIAN_LANDSAT4_LAUNCH&quot;]</span>
        <span class="c1"># we assign an extremely large value to original NA value (255)</span>
        <span class="c1">#    cm_block[cm_block_copy == -9999] = -9999</span>

        <span class="n">cm_block_reshape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="n">cm_block</span><span class="p">,</span> <span class="p">(</span><span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span> <span class="o">*</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span><span class="p">,</span> <span class="n">n_cm_maps</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">hori_profile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hsplit</span><span class="p">(</span><span class="n">cm_block_reshape</span><span class="p">,</span> <span class="n">n_cm_maps</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">maps</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cm_map_list</span><span class="p">):</span>
            <span class="n">maps</span><span class="p">[</span>
                <span class="p">(</span><span class="n">current_block_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span> <span class="p">:</span> <span class="n">current_block_y</span>
                <span class="o">*</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span><span class="p">,</span>
                <span class="p">(</span><span class="n">current_block_x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span> <span class="p">:</span> <span class="n">current_block_x</span>
                <span class="o">*</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span><span class="p">,</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">hori_profile</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span><span class="p">,</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span>
            <span class="p">)</span>

    <span class="c1"># output cm images</span>
    <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">cm_map</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cm_map_list</span><span class="p">):</span>
        <span class="n">ordinal_date</span> <span class="o">=</span> <span class="n">starting_date</span> <span class="o">+</span> <span class="n">count</span> <span class="o">*</span> <span class="n">cm_output_interval</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span>
            <span class="n">cmmap_path</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_maps_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}{}</span><span class="s2">.npy&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">prefix</span><span class="p">,</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">ordinal_date</span><span class="p">),</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">fromordinal</span><span class="p">(</span><span class="n">ordinal_date</span><span class="p">)</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
                <span class="n">get_doy</span><span class="p">(</span><span class="n">ordinal_date</span><span class="p">),</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">cm_map</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">clean</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">tmp_filenames</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">file</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">result_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;_x&quot;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">tmp_filenames</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">result_path</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span></div>



<div class="viewcode-block" id="get_rowcol_intile">
<a class="viewcode-back" href="../../api/pyxccd.utils.html#pyxccd.utils.get_rowcol_intile">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_rowcol_intile</span><span class="p">(</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">block_width</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">block_height</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">block_x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">block_y</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate row and col in original images based on pos index and block location</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    id: int</span>
<span class="sd">        id of the pixel (i.e., i_row * n_cols + i_col). Note starting from 0</span>
<span class="sd">    block_width: int</span>
<span class="sd">        the width of each block</span>
<span class="sd">    block_height: int</span>
<span class="sd">        the height of each block</span>
<span class="sd">    block_x:int</span>
<span class="sd">        block location at x direction</span>
<span class="sd">    block_y:int</span>
<span class="sd">        block location at y direction</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    (int, int)</span>
<span class="sd">        return (original_row, original_col), i.e., row and col number (starting from 1) in original image (e.g., Landsat ARD 5000*5000)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">original_row</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">id</span> <span class="o">/</span> <span class="n">block_width</span> <span class="o">+</span> <span class="p">(</span><span class="n">block_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">block_height</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">original_col</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">id</span> <span class="o">%</span> <span class="n">block_width</span> <span class="o">+</span> <span class="p">(</span><span class="n">block_x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">block_width</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">original_row</span><span class="p">,</span> <span class="n">original_col</span></div>



<div class="viewcode-block" id="get_id_inblock">
<a class="viewcode-back" href="../../api/pyxccd.utils.html#pyxccd.utils.get_id_inblock">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_id_inblock</span><span class="p">(</span><span class="n">pos</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">block_width</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">block_height</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;pixel id in the block, starting from 0</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pos : int</span>
<span class="sd">        position id of a pixel, i.e., i_row * n_cols + i_col + 1</span>
<span class="sd">    block_width : int</span>
<span class="sd">        the width of the block</span>
<span class="sd">    block_height : int</span>
<span class="sd">        the width of the height</span>
<span class="sd">    n_cols : int</span>
<span class="sd">        the number of the culimn</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        pixel id, i.e., i_row * n_cols + i_col</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">row_inblock</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_cols</span><span class="p">)</span> <span class="o">%</span> <span class="n">block_height</span><span class="p">)</span>
    <span class="n">col_inblock</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">n_cols</span> <span class="o">%</span> <span class="n">block_width</span>
    <span class="k">return</span> <span class="n">row_inblock</span> <span class="o">*</span> <span class="n">block_width</span> <span class="o">+</span> <span class="n">col_inblock</span></div>



<span class="c1"># def gdal_save_file_1band(out_path, array, gdal_type, trans, proj, cols, rows, image_format=&#39;GTiff&#39;):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     save array as tiff format</span>
<span class="c1">#     Parameters</span>
<span class="c1">#     ----------</span>
<span class="c1">#     out_path : full outputted path</span>
<span class="c1">#     array : numpy array to be saved</span>
<span class="c1">#     gdal_type: gdal type</span>
<span class="c1">#     trans: transform coefficients</span>
<span class="c1">#     proj: projection</span>
<span class="c1">#     rows: the row number</span>
<span class="c1">#     cols: the col number</span>
<span class="c1">#     image_format: default is GTiff</span>
<span class="c1">#     Returns</span>
<span class="c1">#     -------</span>
<span class="c1">#     TRUE OR FALSE</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     outdriver = gdal.GetDriverByName(image_format)</span>
<span class="c1">#     outdata = outdriver.Create(out_path, cols, rows, 1, gdal_type)</span>
<span class="c1">#     if outdata == None:</span>
<span class="c1">#         return False</span>
<span class="c1">#     outdata.GetRasterBand(1).WriteArray(array)</span>
<span class="c1">#     outdata.FlushCache()</span>
<span class="c1">#     outdata.SetGeoTransform(trans)</span>
<span class="c1">#     outdata.FlushCache()</span>
<span class="c1">#     outdata.SetProjection(proj)</span>
<span class="c1">#     outdata.FlushCache()</span>
<span class="c1">#     return True</span>


<div class="viewcode-block" id="get_time_now">
<a class="viewcode-back" href="../../api/pyxccd.utils.html#pyxccd.utils.get_time_now">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_time_now</span><span class="p">(</span><span class="n">tz</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;get datetime for now</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tz</span>
<span class="sd">        The input time zone</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    datetime</span>
<span class="sd">        datatime format of current time</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span></div>



<span class="c1"># def get_ymd_now(tz):</span>
<span class="c1">#     &quot;&quot;&quot;get datetime for now</span>

<span class="c1">#     Parameters</span>
<span class="c1">#     ----------</span>
<span class="c1">#     tz: str</span>
<span class="c1">#         The input time zone</span>

<span class="c1">#     Returns</span>
<span class="c1">#     -------</span>
<span class="c1">#     datetime</span>
<span class="c1">#         datatime format of current time</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     return datetime.now(tz).strftime(&quot;%Y-%m-%d&quot;)</span>


<div class="viewcode-block" id="get_doy">
<a class="viewcode-back" href="../../api/pyxccd.utils.html#pyxccd.utils.get_doy">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_doy</span><span class="p">(</span><span class="n">ordinal_date</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;get doy from ordinal date</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ordinal_date: int</span>
<span class="sd">        a ordinal date (MATLAB-format ordinal date)</span>

<span class="sd">    Returns:</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        day of year</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">fromordinal</span><span class="p">(</span><span class="n">ordinal_date</span><span class="p">)</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()</span><span class="o">.</span><span class="n">tm_yday</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span></div>



<span class="c1"># def get_anchor_days(starting_day: int, n_cm_maps: int, interval: int):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     get a list of starting days for each change magnitude time slices</span>

<span class="c1">#     Parameters</span>
<span class="c1">#     ----------</span>
<span class="c1">#     starting_days:int</span>
<span class="c1">#         Starting days</span>
<span class="c1">#     n_cm_maps: int</span>
<span class="c1">#         The number of change magnitudes</span>
<span class="c1">#     interval:int</span>
<span class="c1">#         The interval of change magnitudes</span>

<span class="c1">#     Returns</span>
<span class="c1">#     -------</span>
<span class="c1">#         A list of starting day</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     return np.arange(</span>
<span class="c1">#         start=starting_day, stop=starting_day + n_cm_maps * interval, step=interval</span>
<span class="c1">#     )</span>


<div class="viewcode-block" id="assemble_array">
<a class="viewcode-back" href="../../api/pyxccd.utils.html#pyxccd.utils.assemble_array">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">assemble_array</span><span class="p">(</span><span class="n">array_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">n_block_x</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assemble a list of block-based array to a bigger array that aligns with the dimension of an ARD tile</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    array_list: list</span>
<span class="sd">        a list of np.ndarray</span>
<span class="sd">    n_block_x: int</span>
<span class="sd">        block number at x axis</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        an array [nrows, ncols]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">full_feature_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">array_list</span><span class="p">)</span>
    <span class="n">full_feature_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">hsplit</span><span class="p">(</span><span class="n">full_feature_array</span><span class="p">,</span> <span class="n">n_block_x</span><span class="p">)</span>
    <span class="p">)</span>  <span class="c1"># (nrows, ncols, nfeatures)</span>
    <span class="k">return</span> <span class="n">full_feature_array</span></div>



<div class="viewcode-block" id="read_data">
<a class="viewcode-back" href="../../api/pyxccd.utils.html#pyxccd.utils.read_data">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">read_data</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load a sample file containing acquisition days and spectral values.</span>
<span class="sd">    The first column is assumed to be the day number, subsequent columns</span>
<span class="sd">    correspond to the day number. This improves readability of large datasets.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        the path of csv</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span></div>



<span class="c1"># def date2matordinal(year:int, month:int, day:int):</span>
<span class="c1">#     &quot;&quot;&quot;</span>

<span class="c1">#     Parameters</span>
<span class="c1">#     ----------</span>
<span class="c1">#     year : int</span>
<span class="c1">#         _description_</span>
<span class="c1">#     month : int</span>
<span class="c1">#         _descriptdate2matordinalion_</span>
<span class="c1">#     day : int</span>
<span class="c1">#         _description_</span>

<span class="c1">#     Returns</span>
<span class="c1">#     -------</span>
<span class="c1">#     _type_</span>
<span class="c1">#         _description_</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     return pd.Timestamp.toordinal(dt.date(year, month, day))</span>


<span class="c1"># def matordinal2date(ordinal):</span>
<span class="c1">#     return pd.Timestamp.fromordinal(ordinal)</span>


<div class="viewcode-block" id="save_nrtfiles">
<a class="viewcode-back" href="../../api/pyxccd.utils.html#pyxccd.utils.save_nrtfiles">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">save_nrtfiles</span><span class="p">(</span>
    <span class="n">out_folder</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">outfile_prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sccd_pack</span><span class="p">:</span> <span class="n">SccdOutput</span><span class="p">,</span> <span class="n">data_ext</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;save nrt files into local for debug purpose</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    out_folder : str</span>
<span class="sd">        The folder to svae results</span>
<span class="sd">    outfile_prefix : str</span>
<span class="sd">        prefix for saved files</span>
<span class="sd">    sccd_pack : SccdOutput</span>
<span class="sd">        SCCD output</span>
<span class="sd">    data_ext : pd.DataFrame</span>
<span class="sd">        observation as pandas dataframe</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    save all files for C debug</span>
<span class="sd">    :param out_folder: the outputted folder</span>
<span class="sd">    :param outfile_prefix: the prefix of outputted files</span>
<span class="sd">    :param sccd_pack:</span>
<span class="sd">    :param data_ext:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data_ext</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
        <span class="n">join</span><span class="p">(</span><span class="n">out_folder</span><span class="p">,</span> <span class="s2">&quot;spectral_</span><span class="si">{}</span><span class="s2">_extension.csv&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outfile_prefix</span><span class="p">),</span>
        <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># data_ini_current.to_csv(join(out_path, &#39;spectral_{}_ini.csv&#39;).format(pid), index=False, header=False)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sccd_pack</span><span class="o">.</span><span class="n">nrt_mode</span><span class="p">)</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span>
        <span class="n">join</span><span class="p">(</span><span class="n">out_folder</span><span class="p">,</span> <span class="s2">&quot;sccd_pack</span><span class="si">{}</span><span class="s2">_nrt_mode&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outfile_prefix</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">sccd_pack</span><span class="o">.</span><span class="n">rec_cg</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span>
        <span class="n">join</span><span class="p">(</span><span class="n">out_folder</span><span class="p">,</span> <span class="s2">&quot;sccd_pack</span><span class="si">{}</span><span class="s2">_rec_cg&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outfile_prefix</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">sccd_pack</span><span class="o">.</span><span class="n">nrt_model</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span>
        <span class="n">join</span><span class="p">(</span><span class="n">out_folder</span><span class="p">,</span> <span class="s2">&quot;sccd_pack</span><span class="si">{}</span><span class="s2">_nrt_model&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outfile_prefix</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">sccd_pack</span><span class="o">.</span><span class="n">nrt_queue</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span>
        <span class="n">join</span><span class="p">(</span><span class="n">out_folder</span><span class="p">,</span> <span class="s2">&quot;sccd_pack</span><span class="si">{}</span><span class="s2">_nrt_queue&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outfile_prefix</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">sccd_pack</span><span class="o">.</span><span class="n">min_rmse</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span>
        <span class="n">join</span><span class="p">(</span><span class="n">out_folder</span><span class="p">,</span> <span class="s2">&quot;sccd_pack</span><span class="si">{}</span><span class="s2">_min_rmse&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outfile_prefix</span><span class="p">)</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="save_obs2csv">
<a class="viewcode-back" href="../../api/pyxccd.utils.html#pyxccd.utils.save_obs2csv">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">save_obs2csv</span><span class="p">(</span><span class="n">out_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;save observation dataframe to a local csv</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    out_path : str</span>
<span class="sd">        the path for saving csv</span>
<span class="sd">    data : pd.DataFrame</span>
<span class="sd">        data to be outputed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>



<div class="viewcode-block" id="unindex_sccdpack">
<a class="viewcode-back" href="../../api/pyxccd.utils.html#pyxccd.utils.unindex_sccdpack">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">unindex_sccdpack</span><span class="p">(</span><span class="n">sccd_pack_single</span><span class="p">:</span> <span class="n">SccdOutput</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;remove index of sccdpack to save memory</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sccd_pack_single : SccdOutput</span>
<span class="sd">        sccd output</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        a list for five SccdOutput components</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">sccd_pack_single</span> <span class="o">=</span> <span class="n">sccd_pack_single</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
        <span class="n">rec_cg</span><span class="o">=</span><span class="n">sccd_pack_single</span><span class="o">.</span><span class="n">rec_cg</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sccd_pack_single</span><span class="o">.</span><span class="n">nrt_model</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sccd_pack_single</span> <span class="o">=</span> <span class="n">sccd_pack_single</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
            <span class="n">nrt_model</span><span class="o">=</span><span class="n">sccd_pack_single</span><span class="o">.</span><span class="n">nrt_model</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sccd_pack_single</span><span class="o">.</span><span class="n">nrt_queue</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sccd_pack_single</span> <span class="o">=</span> <span class="n">sccd_pack_single</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
            <span class="n">nrt_queue</span><span class="o">=</span><span class="n">sccd_pack_single</span><span class="o">.</span><span class="n">nrt_queue</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">sccd_pack_single</span><span class="p">)</span></div>



<div class="viewcode-block" id="index_sccdpack">
<a class="viewcode-back" href="../../api/pyxccd.utils.html#pyxccd.utils.index_sccdpack">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">index_sccdpack</span><span class="p">(</span><span class="n">sccd_pack_single</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SccdOutput</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;convert a list of SccdOutput components back to namedtuple SccdOutput</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sccd_pack_single : list</span>
<span class="sd">        A list of SccdOutput components</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    SccdOutput</span>
<span class="sd">        sccd output</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    Exception</span>
<span class="sd">       The element number of sccd_pack_single is not five</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sccd_pack_single</span><span class="p">)</span> <span class="o">!=</span> <span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;SCCD&quot;</span><span class="p">][</span><span class="s2">&quot;PACK_ITEM&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="s2">&quot;the element number of sccd_pack_single must be </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;SCCD&quot;</span><span class="p">][</span><span class="s2">&quot;PACK_ITEM&quot;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># convert to named tuple</span>
    <span class="n">sccd_pack_single</span> <span class="o">=</span> <span class="n">SccdOutput</span><span class="p">(</span><span class="o">*</span><span class="n">sccd_pack_single</span><span class="p">)</span>

    <span class="c1"># replace the element to structured array</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sccd_pack_single</span><span class="o">.</span><span class="n">rec_cg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sccd_pack_single</span> <span class="o">=</span> <span class="n">sccd_pack_single</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
            <span class="n">rec_cg</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sccd_pack_single</span><span class="o">.</span><span class="n">rec_cg</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sccd_pack_single</span> <span class="o">=</span> <span class="n">sccd_pack_single</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
            <span class="n">rec_cg</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sccd_pack_single</span><span class="o">.</span><span class="n">rec_cg</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">sccd_dt</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sccd_pack_single</span><span class="o">.</span><span class="n">nrt_model</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sccd_pack_single</span> <span class="o">=</span> <span class="n">sccd_pack_single</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
            <span class="n">nrt_model</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sccd_pack_single</span><span class="o">.</span><span class="n">nrt_model</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">nrtmodel_dt</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sccd_pack_single</span><span class="o">.</span><span class="n">nrt_queue</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sccd_pack_single</span> <span class="o">=</span> <span class="n">sccd_pack_single</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
            <span class="n">nrt_queue</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sccd_pack_single</span><span class="o">.</span><span class="n">nrt_queue</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">nrtqueue_dt</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">sccd_pack_single</span></div>



<div class="viewcode-block" id="save_1band_fromrefimage">
<a class="viewcode-back" href="../../api/pyxccd.utils.html#pyxccd.utils.save_1band_fromrefimage">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">save_1band_fromrefimage</span><span class="p">(</span>
    <span class="n">array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">out_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ref_image_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;save an array into the local as tif, using the georeference from a refimage</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    array : np.ndarray</span>
<span class="sd">        Inputted array to be converted</span>
<span class="sd">    out_path : str</span>
<span class="sd">        Path for the output</span>
<span class="sd">    ref_image_path : str, optional</span>
<span class="sd">        Path for the reference image to copy georeference info, by default None</span>
<span class="sd">    dtype : _type_, optional</span>
<span class="sd">       str or numpy.dtype, optional. The data type for bands. For example: uint8 or rasterio.uint16.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span>

    <span class="k">if</span> <span class="n">ref_image_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;driver&quot;</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span><span class="p">,</span>
            <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">dtype</span><span class="p">,</span>
            <span class="s2">&quot;compress&quot;</span><span class="p">:</span> <span class="s2">&quot;lzw&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ref_image_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
            <span class="n">profile</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">profile</span>
            <span class="n">profile</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">array</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="s2">&quot;lzw&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
        <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></div>



<div class="viewcode-block" id="coefficient_matrix">
<a class="viewcode-back" href="../../api/pyxccd.utils.html#pyxccd.utils.coefficient_matrix">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">coefficient_matrix</span><span class="p">(</span><span class="n">date</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_coefficients</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate cos and sin variables for Fourier transform function</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    date : int</span>
<span class="sd">        Inputted ordinal date</span>
<span class="sd">    num_coefficients : int</span>
<span class="sd">        Number of variables to be outputted, i.e., the length of the matrix as return</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">slope_scale</span> <span class="o">=</span> <span class="mi">10000</span>
    <span class="n">w23</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">365.25</span>
    <span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">num_coefficients</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s2">&quot;F&quot;</span><span class="p">)</span>

    <span class="c1"># lookup optimizations</span>
    <span class="c1"># Before optimization - 12.53% of total runtime</span>
    <span class="c1"># After optimization  - 10.57% of total runtime</span>
    <span class="n">cos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span>
    <span class="n">sin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span>

    <span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">date</span> <span class="o">/</span> <span class="n">slope_scale</span>
    <span class="n">matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">w23</span> <span class="o">*</span> <span class="n">date</span><span class="p">)</span>
    <span class="n">matrix</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">w23</span> <span class="o">*</span> <span class="n">date</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">num_coefficients</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">:</span>
        <span class="n">w45</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">w23</span>
        <span class="n">matrix</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">w45</span> <span class="o">*</span> <span class="n">date</span><span class="p">)</span>
        <span class="n">matrix</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">w45</span> <span class="o">*</span> <span class="n">date</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">num_coefficients</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">w67</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">w23</span>
        <span class="n">matrix</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">w67</span> <span class="o">*</span> <span class="n">date</span><span class="p">)</span>
        <span class="n">matrix</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">w67</span> <span class="o">*</span> <span class="n">date</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">matrix</span></div>



<div class="viewcode-block" id="predict_ref">
<a class="viewcode-back" href="../../api/pyxccd.utils.html#pyxccd.utils.predict_ref">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">predict_ref</span><span class="p">(</span><span class="n">coefs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">date</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_coefficients</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;predicting a single-band reflectance using harmonic coefficients for a date</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    coefs : np.ndarray</span>
<span class="sd">        1-d array for harmonic coefficients</span>
<span class="sd">    date : int</span>
<span class="sd">        ordinal date for the inputted date</span>
<span class="sd">    num_coefficients : int, optional</span>
<span class="sd">        the number of coefs, by default 6</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        the predicted reflectance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">coef_matrix</span> <span class="o">=</span> <span class="n">coefficient_matrix</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">num_coefficients</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">coef_matrix</span><span class="p">,</span> <span class="n">coefs</span><span class="o">.</span><span class="n">T</span><span class="p">)</span></div>



<div class="viewcode-block" id="generate_rowcolimage">
<a class="viewcode-back" href="../../api/pyxccd.utils.html#pyxccd.utils.generate_rowcolimage">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_rowcolimage</span><span class="p">(</span><span class="n">ref_image_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">out_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;a function to convert the reference image to index image (starting from 1, e.g., the first pixel is 100001),</span>
<span class="sd">    which has the same rows and columns as the reference image</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_image_path : str</span>
<span class="sd">        Path of the reference image</span>
<span class="sd">    out_path : str</span>
<span class="sd">        Path of the outputted image</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># ref_image_path = &#39;/home/coloury/Dropbox/UCONN/HLS/HLS.L30.T18TYM.2022074T153249.v2.0.B10.tif&#39;</span>
    <span class="c1"># ref_image = gdal.Open(ref_image_path, gdal.GA_ReadOnly)</span>
    <span class="c1"># trans = ref_image.GetGeoTransform()</span>
    <span class="c1"># proj = ref_image.GetProjection()</span>
    <span class="c1"># cols = ref_image.RasterXSize</span>
    <span class="c1"># rows = ref_image.RasterYSize</span>
    <span class="n">ref_image</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span><span class="n">ref_image_path</span><span class="p">)</span>

    <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">ref_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100000</span> <span class="o">+</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ref_image_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">profile</span>
        <span class="n">profile</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int32&quot;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="s2">&quot;lzw&quot;</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=-</span><span class="mi">9999</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
        <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></div>

    <span class="c1"># save_1band_fromrefimage(index, out_path, ref_image_path, dtype=np.int32)</span>


<div class="viewcode-block" id="calculate_sccd_cm">
<a class="viewcode-back" href="../../api/pyxccd.utils.html#pyxccd.utils.calculate_sccd_cm">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_sccd_cm</span><span class="p">(</span><span class="n">sccd_pack</span><span class="p">:</span> <span class="n">SccdOutput</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;compute median change magnitude for the current anomalies at the tail</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sccd_pack : SccdOutput</span>
<span class="sd">        sccd output</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        computed as the median values for the current anomaly_conse change magnitudes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start_index</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;SCCD&quot;</span><span class="p">][</span><span class="s2">&quot;NRT_BAND&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">sccd_pack</span><span class="o">.</span><span class="n">nrt_model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;anomaly_conse&quot;</span><span class="p">]</span>
    <span class="n">pred_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">[</span>
                <span class="n">predict_ref</span><span class="p">(</span>
                    <span class="n">sccd_pack</span><span class="o">.</span><span class="n">nrt_model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;nrt_coefs&quot;</span><span class="p">][</span><span class="n">b</span><span class="p">],</span>
                    <span class="n">sccd_pack</span><span class="o">.</span><span class="n">nrt_model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;obs_date_since1982&quot;</span><span class="p">][</span><span class="n">i_conse</span> <span class="o">+</span> <span class="n">start_index</span><span class="p">]</span>
                    <span class="o">+</span> <span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;COMMON&quot;</span><span class="p">][</span><span class="s2">&quot;JULIAN_LANDSAT4_LAUNCH&quot;</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">i_conse</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sccd_pack</span><span class="o">.</span><span class="n">nrt_model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;anomaly_conse&quot;</span><span class="p">])</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;SCCD&quot;</span><span class="p">][</span><span class="s2">&quot;NRT_BAND&quot;</span><span class="p">])</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">cm</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">sccd_pack</span><span class="o">.</span><span class="n">nrt_model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;obs&quot;</span><span class="p">][</span>
            <span class="p">:,</span> <span class="n">start_index</span> <span class="p">:</span> <span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;SCCD&quot;</span><span class="p">][</span><span class="s2">&quot;DEFAULT_CONSE&quot;</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="o">-</span> <span class="n">pred_ref</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>



<span class="c1"># from typing import Callable, Any</span>
<span class="c1"># data_class_type = DataclassInstance | type[DataclassInstance]</span>
<span class="c1"># Callable[..., Any],</span>


<div class="viewcode-block" id="class_from_dict">
<a class="viewcode-back" href="../../api/pyxccd.utils.html#pyxccd.utils.class_from_dict">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">class_from_dict</span><span class="p">(</span><span class="n">data_class</span><span class="p">,</span> <span class="n">dict_var</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;convert dictionary to dataclass following the declaration of the dataclass</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data_class :</span>
<span class="sd">        Declare for dataclass</span>
<span class="sd">    dict_var : dict</span>
<span class="sd">        Inputted dictionary</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dataclass</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fieldSet</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">(</span><span class="n">data_class</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">init</span><span class="p">}</span>
    <span class="n">filteredArgDict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dict_var</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">fieldSet</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">data_class</span><span class="p">(</span><span class="o">**</span><span class="n">filteredArgDict</span><span class="p">)</span></div>



<div class="viewcode-block" id="rio_warp">
<a class="viewcode-back" href="../../api/pyxccd.utils.html#pyxccd.utils.rio_warp">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">rio_warp</span><span class="p">(</span><span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">template_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;warp a raster from a template file</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_path : str</span>
<span class="sd">        path of inputted raster</span>
<span class="sd">    output_path : str</span>
<span class="sd">        path of outputted path</span>
<span class="sd">    template_path : str</span>
<span class="sd">        path of template path</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;rio warp </span><span class="si">{</span><span class="n">input_path</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2"> --like </span><span class="si">{</span><span class="n">template_path</span><span class="si">}</span><span class="s2"> --overwrite&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span></div>



<div class="viewcode-block" id="modeby">
<a class="viewcode-back" href="../../api/pyxccd.utils.html#pyxccd.utils.modeby">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">modeby</span><span class="p">(</span><span class="n">input_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">index_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;calculate modes of input_array groupped by index_array.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_array : np.ndarray</span>
<span class="sd">        input array to calculate</span>
<span class="sd">    index_array : np.ndarray</span>
<span class="sd">        the object array, where the same id indicates the pixel for the same object</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        a list of mode value for each object, following ascending order of unique id. modified from: https://stackoverflow.com/questions/49372918/group-numpy-into-multiple-sub-arrays-using-an-array-of-values</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Get argsort indices, to be used to sort a and b in the next steps</span>
    <span class="c1"># input_array = classification_map</span>
    <span class="c1"># index_array = object_map</span>
    <span class="n">sidx</span> <span class="o">=</span> <span class="n">index_array</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;mergesort&quot;</span><span class="p">)</span>
    <span class="n">a_sorted</span> <span class="o">=</span> <span class="n">input_array</span><span class="p">[</span><span class="n">sidx</span><span class="p">]</span>
    <span class="n">b_sorted</span> <span class="o">=</span> <span class="n">index_array</span><span class="p">[</span><span class="n">sidx</span><span class="p">]</span>

    <span class="c1"># Get the group limit indices (start, stop of groups)</span>
    <span class="n">cut_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="n">b_sorted</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">!=</span> <span class="n">b_sorted</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="kc">True</span><span class="p">])</span>

    <span class="c1"># Split input array with those start, stop ones</span>
    <span class="n">split</span> <span class="o">=</span> <span class="p">[</span><span class="n">a_sorted</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cut_idx</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">cut_idx</span><span class="p">[</span><span class="mi">1</span><span class="p">:])]</span>
    <span class="n">mode_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">stats</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">split</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">mode_list</span></div>



<div class="viewcode-block" id="mode_median_by">
<a class="viewcode-back" href="../../api/pyxccd.utils.html#pyxccd.utils.mode_median_by">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">mode_median_by</span><span class="p">(</span>
    <span class="n">input_array_mode</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">input_array_median</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">index_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;_summary_</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_array_mode : np.ndarray</span>
<span class="sd">        input array for calculating mode</span>
<span class="sd">    input_array_median : np.ndarray</span>
<span class="sd">        input array for calculating median</span>
<span class="sd">    index_array : np.ndarray</span>
<span class="sd">        the array for indicating objects. The pixels in the same object have the same ids</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    (list, list)</span>
<span class="sd">        a list of mode value and a list of median value for each object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">sidx</span> <span class="o">=</span> <span class="n">index_array</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;mergesort&quot;</span><span class="p">)</span>
    <span class="n">a1_sorted</span> <span class="o">=</span> <span class="n">input_array_mode</span><span class="p">[</span><span class="n">sidx</span><span class="p">]</span>
    <span class="n">a2_sorted</span> <span class="o">=</span> <span class="n">input_array_median</span><span class="p">[</span><span class="n">sidx</span><span class="p">]</span>
    <span class="n">b_sorted</span> <span class="o">=</span> <span class="n">index_array</span><span class="p">[</span><span class="n">sidx</span><span class="p">]</span>

    <span class="c1"># Get the group limit indices (start, stop of groups)</span>
    <span class="n">cut_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="n">b_sorted</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">!=</span> <span class="n">b_sorted</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="kc">True</span><span class="p">])</span>

    <span class="c1"># Split input array with those start, stop ones</span>
    <span class="n">split_mode</span> <span class="o">=</span> <span class="p">[</span><span class="n">a1_sorted</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cut_idx</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">cut_idx</span><span class="p">[</span><span class="mi">1</span><span class="p">:])]</span>
    <span class="n">split_median</span> <span class="o">=</span> <span class="p">[</span><span class="n">a2_sorted</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cut_idx</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">cut_idx</span><span class="p">[</span><span class="mi">1</span><span class="p">:])]</span>
    <span class="n">mode_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">stats</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">split_mode</span><span class="p">]</span>
    <span class="n">median_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">)])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">split_median</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">mode_list</span><span class="p">,</span> <span class="n">median_list</span></div>



<div class="viewcode-block" id="getcategory_cold">
<a class="viewcode-back" href="../../api/pyxccd.utils.html#pyxccd.utils.getcategory_cold">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">getcategory_cold</span><span class="p">(</span><span class="n">cold_plot</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">i_curve</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">t_c</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">200.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;an empirical way to get break category for COLD algorithm</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cold_plot : np.ndarray</span>
<span class="sd">        Cold result for a single pixel, a structured array of dtype = :py:type:`~pyxccd.common.cold_rec_cg`</span>
<span class="sd">    i_curve : int</span>
<span class="sd">        Curve number to be classified</span>
<span class="sd">    t_c : float, optional</span>
<span class="sd">        The threshold to be used, by default -200.0</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        break category</span>

<span class="sd">            1 - land disturbance</span>

<span class="sd">            2 - regrowth</span>

<span class="sd">            3 - aforestation</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">cold_plot</span><span class="p">[</span><span class="n">i_curve</span><span class="p">][</span><span class="s2">&quot;magnitude&quot;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">t_c</span>
        <span class="ow">and</span> <span class="n">cold_plot</span><span class="p">[</span><span class="n">i_curve</span><span class="p">][</span><span class="s2">&quot;magnitude&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">t_c</span>
        <span class="ow">and</span> <span class="n">cold_plot</span><span class="p">[</span><span class="n">i_curve</span><span class="p">][</span><span class="s2">&quot;magnitude&quot;</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">t_c</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">cold_plot</span><span class="p">[</span><span class="n">i_curve</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;coefs&quot;</span><span class="p">][</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cold_plot</span><span class="p">[</span><span class="n">i_curve</span><span class="p">][</span><span class="s2">&quot;coefs&quot;</span><span class="p">][</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="ow">and</span> <span class="n">cold_plot</span><span class="p">[</span><span class="n">i_curve</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;coefs&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="o">&lt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cold_plot</span><span class="p">[</span><span class="n">i_curve</span><span class="p">][</span><span class="s2">&quot;coefs&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="ow">and</span> <span class="n">cold_plot</span><span class="p">[</span><span class="n">i_curve</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;coefs&quot;</span><span class="p">][</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="o">&lt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cold_plot</span><span class="p">[</span><span class="n">i_curve</span><span class="p">][</span><span class="s2">&quot;coefs&quot;</span><span class="p">][</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="mi">3</span>  <span class="c1"># aforestation</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">2</span>  <span class="c1"># regrowth</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>  <span class="c1"># land disturbance</span></div>



<div class="viewcode-block" id="getcategory_sccd">
<a class="viewcode-back" href="../../api/pyxccd.utils.html#pyxccd.utils.getcategory_sccd">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">getcategory_sccd</span><span class="p">(</span><span class="n">sccd_plot</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">i_curve</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">t_c</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">200.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;an empirical way to get break category for COLD algorithm</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sccd_plot : np.ndarray</span>
<span class="sd">        sccd offline result for a single pixel, a structured array of dtype = :py:type:`~pyxccd.common.rec_cg`</span>
<span class="sd">    i_curve : int</span>
<span class="sd">        Curve number to be classified</span>
<span class="sd">    t_c : float, optional</span>
<span class="sd">        The threshold to be used, by default -200.0</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        break category</span>

<span class="sd">            1 - land disturbance</span>

<span class="sd">            2 - regrowth</span>

<span class="sd">            3 - aforestation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">sccd_plot</span><span class="p">[</span><span class="n">i_curve</span><span class="p">][</span><span class="s2">&quot;magnitude&quot;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">t_c</span>
        <span class="ow">and</span> <span class="n">sccd_plot</span><span class="p">[</span><span class="n">i_curve</span><span class="p">][</span><span class="s2">&quot;magnitude&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">t_c</span>
        <span class="ow">and</span> <span class="n">sccd_plot</span><span class="p">[</span><span class="n">i_curve</span><span class="p">][</span><span class="s2">&quot;magnitude&quot;</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">t_c</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="mi">2</span>  <span class="c1"># regrowth</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>  <span class="c1"># land disturbance</span></div>



<div class="viewcode-block" id="extract_features">
<a class="viewcode-back" href="../../api/pyxccd.utils.html#pyxccd.utils.extract_features">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_features</span><span class="p">(</span>
    <span class="n">cold_plot</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">band</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">ordinal_day_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">nan_val</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">feature_outputs</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;a0&quot;</span><span class="p">,</span> <span class="s2">&quot;a1&quot;</span><span class="p">,</span> <span class="s2">&quot;b1&quot;</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;generate features for classification based on a plot-based rec_cg and a list of days to be predicted</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cold_plot : np.ndarray</span>
<span class="sd">        A structured array of :py:type:`~pyxccd.common.cold_rec_cg`</span>
<span class="sd">    band : int</span>
<span class="sd">        Band index, started from 0, i.e., index 0 is band 1, index 1 is band 2, etc</span>
<span class="sd">    ordinal_day_list : list</span>
<span class="sd">        A list of ordinal day to extract a0, a0 = intercept + slope * a1 / 10000</span>
<span class="sd">    nan_val : int</span>
<span class="sd">        The default values assigned to feature output, by default 0</span>
<span class="sd">    feature_outputs : list, optional</span>
<span class="sd">        Indicate which features to be outputted.  They must be within [a0, c1, a1, b1,a2, b2, a3, b3, rmse],</span>
<span class="sd">        by default [&quot;a0&quot;, &quot;a1&quot;, &quot;b1&quot;]</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A list</span>
<span class="sd">        a list of 1-d array. The length of list is len(feature_outputs); the length of 1-d array is len(ordinal_day_list)</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        The outputted feature must be in [a0, c1, a1, b1,a2, b2, a3, b3, cv, rmse]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">features</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ordinal_day_list</span><span class="p">),</span> <span class="n">nan_val</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">feature_outputs</span><span class="p">))</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">ordinal_day</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ordinal_day_list</span><span class="p">):</span>
        <span class="c1"># print(index)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">cold_curve</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cold_plot</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">cold_plot</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">max_days</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">fromordinal</span><span class="p">(</span><span class="n">cold_plot</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s2">&quot;t_end&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
                <span class="p">)</span><span class="o">.</span><span class="n">toordinal</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">max_days</span> <span class="o">=</span> <span class="n">cold_plot</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;t_start&quot;</span><span class="p">]</span>

            <span class="n">min_day</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1985</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">toordinal</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="k">else</span> <span class="n">cold_curve</span><span class="p">[</span><span class="s2">&quot;t_start&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">min_day</span> <span class="o">&lt;=</span> <span class="n">ordinal_day</span> <span class="o">&lt;</span> <span class="n">max_days</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">feature</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">feature_outputs</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">cold_curve</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>  <span class="c1"># permanent snow</span>
                        <span class="n">features</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">feature</span> <span class="o">==</span> <span class="s2">&quot;a0&quot;</span><span class="p">:</span>
                        <span class="n">features</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">cold_curve</span><span class="p">[</span><span class="s2">&quot;coefs&quot;</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="o">+</span> <span class="n">cold_curve</span><span class="p">[</span><span class="s2">&quot;coefs&quot;</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                            <span class="o">*</span> <span class="n">ordinal_day</span>
                            <span class="o">/</span> <span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;COMMON&quot;</span><span class="p">][</span><span class="s2">&quot;SLOPE_SCALE&quot;</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">index</span><span class="p">]):</span>
                            <span class="n">features</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">elif</span> <span class="n">feature</span> <span class="o">==</span> <span class="s2">&quot;c1&quot;</span><span class="p">:</span>
                        <span class="n">features</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">cold_curve</span><span class="p">[</span><span class="s2">&quot;coefs&quot;</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                            <span class="o">/</span> <span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;COMMON&quot;</span><span class="p">][</span><span class="s2">&quot;SLOPE_SCALE&quot;</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">index</span><span class="p">]):</span>
                            <span class="n">features</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">elif</span> <span class="n">feature</span> <span class="o">==</span> <span class="s2">&quot;a1&quot;</span><span class="p">:</span>
                        <span class="n">features</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">cold_curve</span><span class="p">[</span><span class="s2">&quot;coefs&quot;</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">index</span><span class="p">]):</span>
                            <span class="n">features</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">elif</span> <span class="n">feature</span> <span class="o">==</span> <span class="s2">&quot;b1&quot;</span><span class="p">:</span>
                        <span class="n">features</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">cold_curve</span><span class="p">[</span><span class="s2">&quot;coefs&quot;</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">index</span><span class="p">]):</span>
                            <span class="n">features</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">elif</span> <span class="n">feature</span> <span class="o">==</span> <span class="s2">&quot;a2&quot;</span><span class="p">:</span>
                        <span class="n">features</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">cold_curve</span><span class="p">[</span><span class="s2">&quot;coefs&quot;</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">index</span><span class="p">]):</span>
                            <span class="n">features</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">elif</span> <span class="n">feature</span> <span class="o">==</span> <span class="s2">&quot;b2&quot;</span><span class="p">:</span>
                        <span class="n">features</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">cold_curve</span><span class="p">[</span><span class="s2">&quot;coefs&quot;</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">index</span><span class="p">]):</span>
                            <span class="n">features</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">elif</span> <span class="n">feature</span> <span class="o">==</span> <span class="s2">&quot;a3&quot;</span><span class="p">:</span>
                        <span class="n">features</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">cold_curve</span><span class="p">[</span><span class="s2">&quot;coefs&quot;</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">index</span><span class="p">]):</span>
                            <span class="n">features</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">elif</span> <span class="n">feature</span> <span class="o">==</span> <span class="s2">&quot;b3&quot;</span><span class="p">:</span>
                        <span class="n">features</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">cold_curve</span><span class="p">[</span><span class="s2">&quot;coefs&quot;</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">index</span><span class="p">]):</span>
                            <span class="n">features</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">elif</span> <span class="n">feature</span> <span class="o">==</span> <span class="s2">&quot;rmse&quot;</span><span class="p">:</span>
                        <span class="n">features</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">cold_curve</span><span class="p">[</span><span class="s2">&quot;rmse&quot;</span><span class="p">][</span><span class="n">band</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">index</span><span class="p">]):</span>
                            <span class="n">features</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s2">&quot;the outputted feature must be in [a0, c1, a1, b1,a2, b2, a3, b3, rmse, cv]&quot;</span>
                        <span class="p">)</span>
                <span class="k">break</span>

    <span class="k">if</span> <span class="s2">&quot;cv&quot;</span> <span class="ow">in</span> <span class="n">feature_outputs</span><span class="p">:</span>
        <span class="n">ordinal_day_years</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">fromordinal</span><span class="p">(</span><span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">year</span> <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="n">ordinal_day_list</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">ordinal_year</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ordinal_day_years</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">cold_curve</span> <span class="ow">in</span> <span class="n">cold_plot</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">cold_curve</span><span class="p">[</span><span class="s2">&quot;t_break&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">cold_curve</span><span class="p">[</span><span class="s2">&quot;change_prob&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">100</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">break_year</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">fromordinal</span><span class="p">(</span><span class="n">cold_curve</span><span class="p">[</span><span class="s2">&quot;t_break&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">year</span>
                <span class="k">if</span> <span class="n">break_year</span> <span class="o">==</span> <span class="n">ordinal_year</span><span class="p">:</span>
                    <span class="n">features</span><span class="p">[</span><span class="n">feature_outputs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;cv&quot;</span><span class="p">)][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">cold_curve</span><span class="p">[</span>
                        <span class="s2">&quot;magnitude&quot;</span>
                    <span class="p">][</span><span class="n">band</span><span class="p">]</span>
                    <span class="k">break</span>

    <span class="k">return</span> <span class="n">features</span></div>



<div class="viewcode-block" id="convert_datesince1982">
<a class="viewcode-back" href="../../api/pyxccd.utils.html#pyxccd.utils.convert_datesince1982">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">convert_datesince1982</span><span class="p">(</span><span class="n">date</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;_summary_</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    date : int</span>
<span class="sd">        ordinal date</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.Timestamp</span>
<span class="sd">        _description_</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">fromordinal</span><span class="p">(</span><span class="n">date</span> <span class="o">+</span> <span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;COMMON&quot;</span><span class="p">][</span><span class="s2">&quot;JULIAN_LANDSAT4_LAUNCH&quot;</span><span class="p">])</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Su Ye.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>