

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pyxccd.imagetool.prepare_ard &mdash; pyxccd  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css" />

  
      <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            pyxccd
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial_en.html">Pyxccd Tutorial(English)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial_ch.html">Pyxccd指南(Chinese)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/pyxccd.html">Pyxccd API reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">pyxccd</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">pyxccd.imagetool.prepare_ard</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pyxccd.imagetool.prepare_ard</h1><div class="highlight"><pre>
<span></span><span class="c1"># Author: Su Ye</span>
<span class="c1"># This script is an example for generating block-based stack files from original ARD zip as</span>
<span class="c1"># intermediate inputs to the COLD algorithm in a HPC environment. As preparation, you need to</span>
<span class="c1"># download &#39;_BT&#39; and &#39;_SR&#39; for all Landsat ARD collection 1.</span>
<span class="c1"># This script has 4 steps: 1) warp single-path array to limit the observation inputs for each pixel</span>
<span class="c1"># if single_path is set True; 2) unzip all images and unpack bit-based QA bands; 3)</span>
<span class="c1"># partition each 5000*5000 temporal images to blocks and eliminate those image blocks if no clear,</span>
<span class="c1"># water or snow pixel were in it (so to save disk space and enable independent IO for individual</span>
<span class="c1"># block in later time-series analysis); 4) save each image block to python-native binary format</span>
<span class="c1"># (.npy) into its block folders</span>

<span class="c1"># For a 42-year Landsat ARD C1 tile (~3000 images), this script averagely produces ~350 G intermediate disk</span>
<span class="c1"># files, and takes ~12 mins to finish if 200 EPYC 7452 cores are used.</span>
<span class="c1"># running example:</span>
<span class="c1"># source /home/colory666/env_collect/py310_geo/bin/activate</span>
<span class="c1"># python prepare_ard.py --source_dir=/data/landsat_c2/204_22 --out_dir=/data/results/204_22_stack --yaml_path=/home/colory666/pyxccd/src/python/pyxccd/imagetool/config.yaml  --n_cores=10</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tarfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">dt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xml.etree.ElementTree</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ET</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">Logger</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">click</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pytz</span><span class="w"> </span><span class="kn">import</span> <span class="n">timezone</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">os</span><span class="w"> </span><span class="kn">import</span> <span class="n">listdir</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">os.path</span><span class="w"> </span><span class="kn">import</span> <span class="n">isfile</span><span class="p">,</span> <span class="n">join</span><span class="p">,</span> <span class="n">isdir</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">importlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">resources</span> <span class="k">as</span> <span class="n">importlib_resources</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">multiprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pool</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">functools</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">glob</span><span class="w"> </span><span class="kn">import</span> <span class="n">glob</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dateutil.parser</span><span class="w"> </span><span class="kn">import</span> <span class="n">parse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyxccd.common</span><span class="w"> </span><span class="kn">import</span> <span class="n">DatasetInfo</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyxccd.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">class_from_dict</span><span class="p">,</span> <span class="n">rio_loaddata</span><span class="p">,</span> <span class="n">rio_warp</span>


<span class="c1"># define constant here</span>
<span class="n">QA_CLEAR</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">QA_WATER</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">QA_SHADOW</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">QA_SNOW</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">QA_CLOUD</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">QA_FILL</span> <span class="o">=</span> <span class="mi">255</span>

<span class="n">QA_CIRRUS_HLS</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">QA_WATER_HLS</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">QA_SHADOW_HLS</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">QA_SNOW_HLS</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">QA_CLOUDADJACENT_HLS</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">QA_CLOUD_HLS</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">res</span> <span class="o">=</span> <span class="mi">30</span>


<span class="n">s2_stack_bands</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;B02&quot;</span><span class="p">,</span> <span class="s2">&quot;B03&quot;</span><span class="p">,</span> <span class="s2">&quot;B04&quot;</span><span class="p">,</span> <span class="s2">&quot;B8A&quot;</span><span class="p">,</span> <span class="s2">&quot;B11&quot;</span><span class="p">,</span> <span class="s2">&quot;B12&quot;</span><span class="p">,</span> <span class="s2">&quot;Fmask&quot;</span><span class="p">]</span>
<span class="n">l8_stack_bands</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;B02&quot;</span><span class="p">,</span> <span class="s2">&quot;B03&quot;</span><span class="p">,</span> <span class="s2">&quot;B04&quot;</span><span class="p">,</span> <span class="s2">&quot;B05&quot;</span><span class="p">,</span> <span class="s2">&quot;B06&quot;</span><span class="p">,</span> <span class="s2">&quot;B07&quot;</span><span class="p">,</span> <span class="s2">&quot;Fmask&quot;</span><span class="p">]</span>


<div class="viewcode-block" id="mask_value">
<a class="viewcode-back" href="../../../api/pyxccd.imagetool.prepare_ard.html#pyxccd.imagetool.prepare_ard.mask_value">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">mask_value</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a boolean mask around a certain value in the vector.</span>

<span class="sd">    Args:</span>
<span class="sd">        vector: 1-d ndarray of values</span>
<span class="sd">        val: values to mask on</span>
<span class="sd">    Returns:</span>
<span class="sd">        1-d boolean ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">vector</span> <span class="o">==</span> <span class="n">val</span></div>



<div class="viewcode-block" id="qabitval_array_HLS">
<a class="viewcode-back" href="../../../api/pyxccd.imagetool.prepare_ard.html#pyxccd.imagetool.prepare_ard.qabitval_array_HLS">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">qabitval_array_HLS</span><span class="p">(</span><span class="n">packedint_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Institute a hierarchy of qa values that may be flagged in the bitpacked</span>
<span class="sd">    value.</span>

<span class="sd">    fill &gt; cloud &gt; shadow &gt; snow &gt; water &gt; clear</span>

<span class="sd">    Args:</span>
<span class="sd">        packedint: int value to bit check</span>
<span class="sd">    Returns:</span>
<span class="sd">        offset value to use</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">unpacked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">packedint_array</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">QA_CLOUD_unpacked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">packedint_array</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">QA_CLOUD_ADJ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">packedint_array</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">QA_SHADOW_unpacked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">packedint_array</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">QA_SNOW_unpacked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">packedint_array</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">QA_WATER_unpacked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">packedint_array</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span>

    <span class="n">unpacked</span><span class="p">[</span><span class="n">QA_WATER_unpacked</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">QA_WATER</span>
    <span class="n">unpacked</span><span class="p">[</span><span class="n">QA_SNOW_unpacked</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">QA_SNOW</span>
    <span class="n">unpacked</span><span class="p">[</span><span class="n">QA_SHADOW_unpacked</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">QA_SHADOW</span>
    <span class="n">unpacked</span><span class="p">[</span><span class="n">QA_CLOUD_ADJ</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">QA_CLOUD</span>
    <span class="n">unpacked</span><span class="p">[</span><span class="n">QA_CLOUD_unpacked</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">QA_CLOUD</span>
    <span class="n">unpacked</span><span class="p">[</span><span class="n">packedint_array</span> <span class="o">==</span> <span class="n">QA_FILL</span><span class="p">]</span> <span class="o">=</span> <span class="n">QA_FILL</span>

    <span class="k">return</span> <span class="n">unpacked</span></div>



<div class="viewcode-block" id="qabitval_array">
<a class="viewcode-back" href="../../../api/pyxccd.imagetool.prepare_ard.html#pyxccd.imagetool.prepare_ard.qabitval_array">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">qabitval_array</span><span class="p">(</span><span class="n">packedint_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Institute a hierarchy of qa values that may be flagged in the bitpacked</span>
<span class="sd">    value.</span>
<span class="sd">    fill &gt; cloud &gt; shadow &gt; snow &gt; water &gt; clear</span>
<span class="sd">    Args:</span>
<span class="sd">        packedint: int value to bit check</span>
<span class="sd">    Returns:</span>
<span class="sd">        offset value to use</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">unpacked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">packedint_array</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">QA_FILL</span><span class="p">)</span>
    <span class="n">QA_CLOUD_unpacked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">packedint_array</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">QA_CLOUD</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">QA_SHADOW_unpacked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">packedint_array</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">QA_SHADOW</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">QA_SNOW_unpacked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">packedint_array</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">QA_SNOW</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">QA_WATER_unpacked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">packedint_array</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">QA_WATER</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">QA_CLEAR_unpacked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">packedint_array</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">QA_CLEAR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

    <span class="n">unpacked</span><span class="p">[</span><span class="n">QA_CLEAR_unpacked</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">QA_CLEAR</span>
    <span class="n">unpacked</span><span class="p">[</span><span class="n">QA_WATER_unpacked</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">QA_WATER</span>
    <span class="n">unpacked</span><span class="p">[</span><span class="n">QA_SNOW_unpacked</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">QA_SNOW</span>
    <span class="n">unpacked</span><span class="p">[</span><span class="n">QA_SHADOW_unpacked</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">QA_SHADOW</span>
    <span class="n">unpacked</span><span class="p">[</span><span class="n">QA_CLOUD_unpacked</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">QA_CLOUD</span>
    <span class="k">return</span> <span class="n">unpacked</span></div>



<div class="viewcode-block" id="qabitval_array_c2">
<a class="viewcode-back" href="../../../api/pyxccd.imagetool.prepare_ard.html#pyxccd.imagetool.prepare_ard.qabitval_array_c2">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">qabitval_array_c2</span><span class="p">(</span><span class="n">packedint_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Institute a hierarchy of qa values that may be flagged in the bitpacked</span>
<span class="sd">    value for c2</span>

<span class="sd">    fill &gt; cloud &gt; shadow &gt; snow &gt; water &gt; clear</span>

<span class="sd">    Args:</span>
<span class="sd">        packedint: int value to bit check</span>
<span class="sd">    Returns:</span>
<span class="sd">        offset value to use</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">unpacked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">packedint_array</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">QA_FILL</span><span class="p">)</span>
    <span class="n">QA_CLEAR_unpacked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">packedint_array</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span>
    <span class="n">QA_SHADOW_unpacked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">packedint_array</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">QA_CLOUD_unpacked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">packedint_array</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">QA_DILATED_unpacked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">packedint_array</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">QA_SNOW_unpacked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">packedint_array</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">QA_WATER_unpacked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">packedint_array</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span>

    <span class="n">unpacked</span><span class="p">[</span><span class="n">QA_CLEAR_unpacked</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">QA_CLEAR</span>
    <span class="n">unpacked</span><span class="p">[</span><span class="n">QA_WATER_unpacked</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">QA_WATER</span>
    <span class="n">unpacked</span><span class="p">[</span><span class="n">QA_SNOW_unpacked</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">QA_SNOW</span>
    <span class="n">unpacked</span><span class="p">[</span><span class="n">QA_SHADOW_unpacked</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">QA_SHADOW</span>
    <span class="n">unpacked</span><span class="p">[</span><span class="n">QA_CLOUD_unpacked</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">QA_CLOUD</span>
    <span class="n">unpacked</span><span class="p">[</span><span class="n">QA_DILATED_unpacked</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">QA_CLOUD</span>

    <span class="k">return</span> <span class="n">unpacked</span></div>



<div class="viewcode-block" id="single_image_stacking_hls">
<a class="viewcode-back" href="../../../api/pyxccd.imagetool.prepare_ard.html#pyxccd.imagetool.prepare_ard.single_image_stacking_hls">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">single_image_stacking_hls</span><span class="p">(</span>
    <span class="n">source_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">out_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">logger</span><span class="p">:</span> <span class="n">Logger</span><span class="p">,</span>
    <span class="n">dataset_info</span><span class="p">:</span> <span class="n">DatasetInfo</span><span class="p">,</span>
    <span class="n">is_partition</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">clear_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">low_date_bound</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">upp_date_bound</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">folder</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    unzip single image, convert bit-pack qa to byte value, and save as numpy</span>
<span class="sd">    :param source_dir: the parent folder to save image &#39;folder&#39;</span>
<span class="sd">    :param out_dir: the folder to save result</span>
<span class="sd">    :param logger: the handler of logger file</span>
<span class="sd">    :param data_info: data info data class</span>
<span class="sd">    :param is_partition: True, partition each image into blocks; False, save original size of image</span>
<span class="sd">    :param clear_threshold: threshold of clear pixel percentage, if lower than threshold, won&#39;t be processed</span>
<span class="sd">    :param low_date_bound: the lower date of user interested date range</span>
<span class="sd">    :param upp_date_bound: the upper date of user interested date range</span>
<span class="sd">    :param folder: the folder name of image</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">QA_band</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">.Fmask.tif&quot;</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># logger.error(&#39;Cannot open QA band for {}: {}&#39;.format(folder, e))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot open QA band for </span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># convertQA = np.vectorize(qabitval)</span>
    <span class="n">QA_band_unpacked</span> <span class="o">=</span> <span class="n">qabitval_array_HLS</span><span class="p">(</span><span class="n">QA_band</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">short</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">clear_threshold</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">clear_ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">QA_band_unpacked</span> <span class="o">==</span> <span class="n">QA_CLEAR</span><span class="p">,</span> <span class="n">QA_band_unpacked</span> <span class="o">==</span> <span class="n">QA_WATER</span><span class="p">)</span>
        <span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">QA_band_unpacked</span> <span class="o">!=</span> <span class="n">QA_FILL</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">clear_ratio</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">clear_ratio</span> <span class="o">&gt;</span> <span class="n">clear_threshold</span><span class="p">:</span>
        <span class="p">[</span><span class="n">collection</span><span class="p">,</span> <span class="n">sensor</span><span class="p">,</span> <span class="n">tile_id</span><span class="p">,</span> <span class="n">imagetime</span><span class="p">,</span> <span class="n">version1</span><span class="p">,</span> <span class="n">version2</span><span class="p">]</span> <span class="o">=</span> <span class="n">folder</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span>
            <span class="s2">&quot;.&quot;</span>
        <span class="p">)</span>
        <span class="n">year</span> <span class="o">=</span> <span class="n">imagetime</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">doy</span> <span class="o">=</span> <span class="n">imagetime</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">sensor</span> <span class="o">+</span> <span class="n">tile_id</span> <span class="o">+</span> <span class="n">year</span> <span class="o">+</span> <span class="n">doy</span> <span class="o">+</span> <span class="n">collection</span> <span class="o">+</span> <span class="n">version1</span>
        <span class="k">if</span> <span class="n">low_date_bound</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">doy</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">parse</span><span class="p">(</span>
                <span class="n">low_date_bound</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">upp_date_bound</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">doy</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">parse</span><span class="p">(</span>
                <span class="n">upp_date_bound</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">sensor</span> <span class="o">==</span> <span class="s2">&quot;L30&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">b1</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.B02.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">)))</span>
                <span class="n">b2</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.B03.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">)))</span>
                <span class="n">b3</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.B04.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">)))</span>
                <span class="n">b4</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.B05.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">)))</span>
                <span class="n">b5</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.B06.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">)))</span>
                <span class="n">b6</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.B07.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">)))</span>
                <span class="n">b7</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">b6</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># assign zero</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># logger.error(&#39;Cannot open spectral bands for {}: {}&#39;.format(folder, e))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Cannot open Landsat bands for </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">b1</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.B02.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">)))</span>
                <span class="n">b2</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.B03.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">)))</span>
                <span class="n">b3</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.B04.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">)))</span>
                <span class="n">b4</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.B8A.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">)))</span>
                <span class="n">b5</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.B11.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">)))</span>
                <span class="n">b6</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.B12.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">)))</span>
                <span class="n">b7</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">b6</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># logger.error(&#39;Cannot open spectral bands for {}: {}&#39;.format(folder, e))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Cannot open Landsat bands for </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">b1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">b2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">b3</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">b4</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">b5</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">b6</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Reading Landsat band fails for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">is_partition</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># width of a block</span>
            <span class="n">bytesize</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># short16 = 2 * byte</span>
            <span class="c1"># source: https://towardsdatascience.com/efficiently-splitting-an-image-into-tiles-in-python-using-numpy-d1bf0dd7b6f7</span>
            <span class="n">B1_blocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span>
                <span class="n">b1</span><span class="p">,</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_y</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_x</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">strides</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">bytesize</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">B2_blocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span>
                <span class="n">b2</span><span class="p">,</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_y</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_x</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">strides</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">bytesize</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">B3_blocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span>
                <span class="n">b3</span><span class="p">,</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_y</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_x</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">strides</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">bytesize</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">B4_blocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span>
                <span class="n">b4</span><span class="p">,</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_y</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_x</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">strides</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">bytesize</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">B5_blocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span>
                <span class="n">b5</span><span class="p">,</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_y</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_x</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">strides</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">bytesize</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">B6_blocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span>
                <span class="n">b6</span><span class="p">,</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_y</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_x</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">strides</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">bytesize</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">B7_blocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span>
                <span class="n">b7</span><span class="p">,</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_y</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_x</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">strides</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">bytesize</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">QA_blocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span>
                <span class="n">QA_band_unpacked</span><span class="p">,</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_y</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_x</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">strides</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">bytesize</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_y</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_x</span><span class="p">):</span>
                    <span class="c1"># check if no valid pixels in the chip, then eliminate</span>
                    <span class="n">qa_unique</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">QA_blocks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>

                    <span class="c1"># skip blocks are all cloud, shadow or filled values</span>
                    <span class="c1"># in DHTC, we also don&#39;t need to save pixel that has qa value of &#39;QA_CLOUD&#39;,</span>
                    <span class="c1"># &#39;QA_SHADOW&#39;, or FILLED value (255)</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">QA_CLEAR</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">qa_unique</span>
                        <span class="ow">and</span> <span class="n">QA_WATER</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">qa_unique</span>
                        <span class="ow">and</span> <span class="n">QA_SNOW</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">qa_unique</span>
                    <span class="p">):</span>
                        <span class="k">continue</span>

                    <span class="n">block_folder</span> <span class="o">=</span> <span class="s2">&quot;block_x</span><span class="si">{}</span><span class="s2">_y</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
                        <span class="n">join</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">block_folder</span><span class="p">),</span> <span class="n">file_name</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="n">B1_blocks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
                                <span class="n">B2_blocks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
                                <span class="n">B3_blocks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
                                <span class="n">B4_blocks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
                                <span class="n">B5_blocks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
                                <span class="n">B6_blocks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
                                <span class="n">B7_blocks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
                                <span class="n">QA_blocks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
                            <span class="p">]</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
                    <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
                <span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">([</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">b3</span><span class="p">,</span> <span class="n">b4</span><span class="p">,</span> <span class="n">b5</span><span class="p">,</span> <span class="n">b6</span><span class="p">,</span> <span class="n">b7</span><span class="p">,</span> <span class="n">QA_band_unpacked</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">int16</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="c1"># scene_list.append(folder_name)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># logger.info(&#39;Not enough clear observations for {}&#39;.format(folder[0:len(folder) - 3]))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Not enough clear observations for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>

    <span class="k">return</span> <span class="kc">True</span></div>



<div class="viewcode-block" id="single_image_stacking">
<a class="viewcode-back" href="../../../api/pyxccd.imagetool.prepare_ard.html#pyxccd.imagetool.prepare_ard.single_image_stacking">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">single_image_stacking</span><span class="p">(</span>
    <span class="n">tmp_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">source_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">out_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">clear_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">path_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">logger</span><span class="p">:</span> <span class="n">Logger</span><span class="p">,</span>
    <span class="n">dataset_info</span><span class="p">:</span> <span class="n">DatasetInfo</span><span class="p">,</span>
    <span class="n">is_partition</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">low_date_bound</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">upp_date_bound</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">b_c2</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">folder</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    unzip single image, convert bit-pack qa to byte value, and save as numpy</span>
<span class="sd">    :param tmp_path: tmp folder to save unzip image</span>
<span class="sd">    :param source_dir: image folder save source zipped files</span>
<span class="sd">    :param out_dir: the folder to save result</span>
<span class="sd">    :param clear_threshold: threshold of clear pixel percentage, if lower than threshold, won&#39;t be processed</span>
<span class="sd">    :param path_array: path array has the same dimension of inputted image, and the pixel value indicates</span>
<span class="sd">                      the path which the pixel belongs to; if path_array == none, we will use all path</span>
<span class="sd">    :param logger: the handler of logger file</span>
<span class="sd">    :param dataset_info: dataset information</span>
<span class="sd">    :param is_partition: True, partition each image into blocks; False, save original size of image</span>
<span class="sd">    :param low_date_bound: the lower bound of user interested year range</span>
<span class="sd">    :param upp_date_bound: the upper bound of user interested year range</span>
<span class="sd">    :param b_c2: False</span>
<span class="sd">    :param folder: the folder name of image</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># unzip SR</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">)):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">),</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;SR&quot;</span><span class="p">,</span> <span class="s2">&quot;BT&quot;</span><span class="p">))):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;SR&quot;</span><span class="p">,</span> <span class="s2">&quot;BT&quot;</span><span class="p">)),</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;.tar&quot;</span><span class="p">))</span> <span class="k">as</span> <span class="n">tar_ref</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tar_ref</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># logger.warning(&#39;Unzip fails for {}&#39;.format(folder))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unzip fails for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
                <span class="k">return</span>
    <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unzip fails for </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
        <span class="c1"># return</span>

    <span class="c1"># unzip BT</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
            <span class="n">join</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="n">folder</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;SR&quot;</span><span class="p">,</span> <span class="s2">&quot;BT&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.tar&quot;</span><span class="p">)</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">tar_ref</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tar_ref</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;SR&quot;</span><span class="p">,</span> <span class="s2">&quot;BT&quot;</span><span class="p">)))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># logger.warning(&#39;Unzip fails for {}&#39;.format(folder.replace(&quot;SR&quot;, &quot;BT&quot;)))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unzip fails for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;SR&quot;</span><span class="p">,</span> <span class="s2">&quot;BT&quot;</span><span class="p">)))</span>
                <span class="k">return</span>
    <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unzip fails for </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;SR&quot;</span><span class="p">,</span> <span class="s2">&quot;BT&quot;</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">isdir</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;SR&quot;</span><span class="p">,</span> <span class="s2">&quot;BT&quot;</span><span class="p">))):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Fail to locate BT folder for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">b_c2</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">QA_band</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span>
                <span class="n">join</span><span class="p">(</span>
                    <span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">),</span>
                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_PIXELQA.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]),</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">QA_band</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span>
                <span class="n">join</span><span class="p">(</span>
                    <span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">),</span>
                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_QA_PIXEL.TIF&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]),</span>
                <span class="p">)</span>
            <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># logger.error(&#39;Cannot open QA band for {}: {}&#39;.format(folder, e))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Cannot open QA band for </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="c1"># convertQA = np.vectorize(qabitval)</span>
    <span class="k">if</span> <span class="n">b_c2</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">QA_band_unpacked</span> <span class="o">=</span> <span class="n">qabitval_array</span><span class="p">(</span><span class="n">QA_band</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">short</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">QA_band_unpacked</span> <span class="o">=</span> <span class="n">qabitval_array_c2</span><span class="p">(</span><span class="n">QA_band</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">short</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">clear_threshold</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">clear_ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">QA_band_unpacked</span> <span class="o">==</span> <span class="n">QA_CLEAR</span><span class="p">,</span> <span class="n">QA_band_unpacked</span> <span class="o">==</span> <span class="n">QA_WATER</span><span class="p">)</span>
        <span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">QA_band_unpacked</span> <span class="o">!=</span> <span class="n">QA_FILL</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">clear_ratio</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">clear_ratio</span> <span class="o">&gt;</span> <span class="n">clear_threshold</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">folder</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;5&quot;</span><span class="p">:</span>
            <span class="n">sensor</span> <span class="o">=</span> <span class="s2">&quot;LT5&quot;</span>
        <span class="k">elif</span> <span class="n">folder</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;7&quot;</span><span class="p">:</span>
            <span class="n">sensor</span> <span class="o">=</span> <span class="s2">&quot;LE7&quot;</span>
        <span class="k">elif</span> <span class="n">folder</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;8&quot;</span><span class="p">:</span>
            <span class="n">sensor</span> <span class="o">=</span> <span class="s2">&quot;LC8&quot;</span>
        <span class="k">elif</span> <span class="n">folder</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>
            <span class="n">sensor</span> <span class="o">=</span> <span class="s2">&quot;LT4&quot;</span>
        <span class="k">elif</span> <span class="n">folder</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;9&quot;</span><span class="p">:</span>
            <span class="n">sensor</span> <span class="o">=</span> <span class="s2">&quot;LC9&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Sensor is not correctly formatted for the scene </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">col</span> <span class="o">=</span> <span class="n">folder</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">folder</span><span class="p">[</span><span class="mi">11</span><span class="p">:</span><span class="mi">14</span><span class="p">]</span>
        <span class="n">year</span> <span class="o">=</span> <span class="n">folder</span><span class="p">[</span><span class="mi">15</span><span class="p">:</span><span class="mi">19</span><span class="p">]</span>
        <span class="n">doy</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">folder</span><span class="p">[</span><span class="mi">19</span><span class="p">:</span><span class="mi">21</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">folder</span><span class="p">[</span><span class="mi">21</span><span class="p">:</span><span class="mi">23</span><span class="p">]))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%j&quot;</span><span class="p">)</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="s2">&quot;C</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">[</span><span class="mi">35</span><span class="p">:</span><span class="mi">36</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">b_c2</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">version</span> <span class="o">=</span> <span class="n">folder</span><span class="p">[</span><span class="mi">37</span><span class="p">:</span><span class="mi">40</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">version</span> <span class="o">=</span> <span class="n">folder</span><span class="p">[</span><span class="mi">34</span><span class="p">:</span><span class="mi">35</span><span class="p">]</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">sensor</span> <span class="o">+</span> <span class="n">col</span> <span class="o">+</span> <span class="n">row</span> <span class="o">+</span> <span class="n">year</span> <span class="o">+</span> <span class="n">doy</span> <span class="o">+</span> <span class="n">collection</span> <span class="o">+</span> <span class="n">version</span>
        <span class="k">if</span> <span class="n">low_date_bound</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">doy</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">parse</span><span class="p">(</span>
                <span class="n">low_date_bound</span>
            <span class="p">):</span>
                <span class="k">return</span>
        <span class="k">if</span> <span class="n">upp_date_bound</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">doy</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">parse</span><span class="p">(</span>
                <span class="n">upp_date_bound</span>
            <span class="p">):</span>
                <span class="k">return</span>
        <span class="k">if</span> <span class="n">b_c2</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sensor</span> <span class="o">==</span> <span class="s2">&quot;LT5&quot;</span> <span class="ow">or</span> <span class="n">sensor</span> <span class="o">==</span> <span class="s2">&quot;LE7&quot;</span> <span class="ow">or</span> <span class="n">sensor</span> <span class="o">==</span> <span class="s2">&quot;LT4&quot;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">b1</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span>
                        <span class="n">join</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">b1.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
                    <span class="p">)</span>
                    <span class="n">b2</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span>
                        <span class="n">join</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">b2.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
                    <span class="p">)</span>
                    <span class="n">b3</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span>
                        <span class="n">join</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">b3.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
                    <span class="p">)</span>
                    <span class="n">b4</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span>
                        <span class="n">join</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">b4.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
                    <span class="p">)</span>
                    <span class="n">b5</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span>
                        <span class="n">join</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">b5.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
                    <span class="p">)</span>
                    <span class="n">b6</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span>
                        <span class="n">join</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">b7.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
                    <span class="p">)</span>
                    <span class="n">b7</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span>
                        <span class="n">join</span><span class="p">(</span>
                            <span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_BT&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">])),</span>
                            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_BTB6.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]),</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c1"># logger.error(&#39;Cannot open spectral bands for {}: {}&#39;.format(folder, e))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;Cannot open Landsat bands for </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">return</span>
            <span class="k">elif</span> <span class="n">sensor</span> <span class="o">==</span> <span class="s2">&quot;LC8&quot;</span> <span class="ow">or</span> <span class="s2">&quot;LC9&quot;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">b1</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span>
                        <span class="n">join</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">b2.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
                    <span class="p">)</span>
                    <span class="n">b2</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span>
                        <span class="n">join</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">b3.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
                    <span class="p">)</span>
                    <span class="n">b3</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span>
                        <span class="n">join</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">b4.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
                    <span class="p">)</span>
                    <span class="n">b4</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span>
                        <span class="n">join</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">b5.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
                    <span class="p">)</span>
                    <span class="n">b5</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span>
                        <span class="n">join</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">b6.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
                    <span class="p">)</span>
                    <span class="n">b6</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span>
                        <span class="n">join</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">b7.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
                    <span class="p">)</span>
                    <span class="n">b7</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span>
                        <span class="n">join</span><span class="p">(</span>
                            <span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_BT&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">])),</span>
                            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_BTB10.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]),</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c1"># logger.error(&#39;Cannot open spectral bands for {}: {}&#39;.format(folder, e))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;Cannot open Landsat bands for </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sensor</span> <span class="o">==</span> <span class="s2">&quot;LT5&quot;</span> <span class="ow">or</span> <span class="n">sensor</span> <span class="o">==</span> <span class="s2">&quot;LE7&quot;</span> <span class="ow">or</span> <span class="n">sensor</span> <span class="o">==</span> <span class="s2">&quot;LT4&quot;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">b1</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span>
                        <span class="n">join</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_B1.TIF&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
                    <span class="p">)</span>
                    <span class="n">b2</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span>
                        <span class="n">join</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_B2.TIF&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
                    <span class="p">)</span>
                    <span class="n">b3</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span>
                        <span class="n">join</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_B3.TIF&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
                    <span class="p">)</span>
                    <span class="n">b4</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span>
                        <span class="n">join</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_B4.TIF&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
                    <span class="p">)</span>
                    <span class="n">b5</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span>
                        <span class="n">join</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_B5.TIF&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
                    <span class="p">)</span>
                    <span class="n">b6</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span>
                        <span class="n">join</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_B7.TIF&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
                    <span class="p">)</span>
                    <span class="n">b7</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span>
                        <span class="n">join</span><span class="p">(</span>
                            <span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_BT&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">])),</span>
                            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_BT_B6.TIF&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]),</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c1"># logger.error(&#39;Cannot open spectral bands for {}: {}&#39;.format(folder, e))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;Cannot open Landsat bands for </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">return</span>
            <span class="k">elif</span> <span class="n">sensor</span> <span class="o">==</span> <span class="s2">&quot;LC8&quot;</span> <span class="ow">or</span> <span class="s2">&quot;LC9&quot;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">b1</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span>
                        <span class="n">join</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_B2.TIF&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
                    <span class="p">)</span>
                    <span class="n">b2</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span>
                        <span class="n">join</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_B3.TIF&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
                    <span class="p">)</span>
                    <span class="n">b3</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span>
                        <span class="n">join</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_B4.TIF&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
                    <span class="p">)</span>
                    <span class="n">b4</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span>
                        <span class="n">join</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_B5.TIF&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
                    <span class="p">)</span>
                    <span class="n">b5</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span>
                        <span class="n">join</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_B6.TIF&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
                    <span class="p">)</span>
                    <span class="n">b6</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span>
                        <span class="n">join</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_B7.TIF&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
                    <span class="p">)</span>
                    <span class="n">b7</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span>
                        <span class="n">join</span><span class="p">(</span>
                            <span class="n">tmp_path</span><span class="p">,</span>
                            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_BT&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]),</span>
                            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_BT_B10.TIF&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]),</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c1"># logger.error(&#39;Cannot open spectral bands for {}: {}&#39;.format(folder, e))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;Cannot open Landsat bands for </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">return</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">b1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">b2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">b3</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">b4</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">b5</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">b6</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">b7</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Reading Landsat band fails for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">b_c2</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">b1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10000</span> <span class="o">*</span> <span class="p">(</span><span class="n">b1</span> <span class="o">*</span> <span class="mf">2.75e-05</span> <span class="o">-</span> <span class="mf">0.2</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
            <span class="n">b2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10000</span> <span class="o">*</span> <span class="p">(</span><span class="n">b2</span> <span class="o">*</span> <span class="mf">2.75e-05</span> <span class="o">-</span> <span class="mf">0.2</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
            <span class="n">b3</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10000</span> <span class="o">*</span> <span class="p">(</span><span class="n">b3</span> <span class="o">*</span> <span class="mf">2.75e-05</span> <span class="o">-</span> <span class="mf">0.2</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
            <span class="n">b4</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10000</span> <span class="o">*</span> <span class="p">(</span><span class="n">b4</span> <span class="o">*</span> <span class="mf">2.75e-05</span> <span class="o">-</span> <span class="mf">0.2</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
            <span class="n">b5</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10000</span> <span class="o">*</span> <span class="p">(</span><span class="n">b5</span> <span class="o">*</span> <span class="mf">2.75e-05</span> <span class="o">-</span> <span class="mf">0.2</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
            <span class="n">b7</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10000</span> <span class="o">*</span> <span class="p">(</span><span class="n">b7</span> <span class="o">*</span> <span class="mf">2.75e-05</span> <span class="o">-</span> <span class="mf">0.2</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
            <span class="n">b6</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="p">(</span><span class="n">b6</span> <span class="o">*</span> <span class="mf">0.00341802</span> <span class="o">+</span> <span class="mi">149</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>

        <span class="c1"># if path_array is not None, we will eliminate those observation that has different path with its assigned path</span>
        <span class="k">if</span> <span class="n">path_array</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># meaning that single-path processing</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span>
                <span class="n">join</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">),</span> <span class="n">folder</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_SR&quot;</span><span class="p">,</span> <span class="s2">&quot;.xml&quot;</span><span class="p">))</span>
            <span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot find xml file for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">join</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">),</span> <span class="n">folder</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_SR&quot;</span><span class="p">,</span> <span class="s2">&quot;.xml&quot;</span><span class="p">))</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">),</span> <span class="n">folder</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_SR&quot;</span><span class="p">,</span> <span class="s2">&quot;.xml&quot;</span><span class="p">)))</span>

            <span class="c1"># get root element</span>
            <span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">b_c2</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">elements</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span>
                    <span class="s2">&quot;./{https://landsat.usgs.gov/ard/v1}scene_metadata/{https://landsat.usgs.gov/&quot;</span>
                    <span class="s2">&quot;ard/v1}global_metadata/{https://landsat.usgs.gov/ard/v1}wrs&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">elements</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;SCENE_METADATA/IMAGE_ATTRIBUTES&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Parsing xml fails for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">b_c2</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">pathid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">pathid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;path id could not be located.&quot;</span><span class="p">)</span>
            <span class="c1"># print(pathid)</span>

            <span class="c1"># assign filled value to the pixels has different path id so won&#39;t be processed</span>
            <span class="n">QA_band_unpacked</span><span class="p">[</span><span class="n">path_array</span> <span class="o">!=</span> <span class="n">pathid</span><span class="p">]</span> <span class="o">=</span> <span class="n">QA_FILL</span>

        <span class="k">if</span> <span class="n">is_partition</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># width of a block</span>
            <span class="n">bytesize</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># short16 = 2 * byte</span>
            <span class="c1"># source: https://towardsdatascience.com/efficiently-splitting-an-image-into-tiles-in-python-using-numpy-d1bf0dd7b6f7</span>
            <span class="n">B1_blocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span>
                <span class="n">b1</span><span class="p">,</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_y</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_x</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">strides</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">bytesize</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">B2_blocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span>
                <span class="n">b2</span><span class="p">,</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_y</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_x</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">strides</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">bytesize</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">B3_blocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span>
                <span class="n">b3</span><span class="p">,</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_y</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_x</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">strides</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">bytesize</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">B4_blocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span>
                <span class="n">b4</span><span class="p">,</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_y</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_x</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">strides</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">bytesize</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">B5_blocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span>
                <span class="n">b5</span><span class="p">,</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_y</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_x</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">strides</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">bytesize</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">B6_blocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span>
                <span class="n">b6</span><span class="p">,</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_y</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_x</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">strides</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">bytesize</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">B7_blocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span>
                <span class="n">b7</span><span class="p">,</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_y</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_x</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">strides</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">bytesize</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">QA_blocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span>
                <span class="n">QA_band_unpacked</span><span class="p">,</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_y</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_x</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">strides</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">bytesize</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_y</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_x</span><span class="p">):</span>
                    <span class="c1"># check if no valid pixels in the chip, then eliminate</span>
                    <span class="n">qa_unique</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">QA_blocks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>

                    <span class="c1"># skip blocks are all cloud, shadow or filled values</span>
                    <span class="c1"># in DHTC, we also don&#39;t need to save pixel that has qa value of &#39;QA_CLOUD&#39;,</span>
                    <span class="c1"># &#39;QA_SHADOW&#39;, or FILLED value (255)</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">QA_CLEAR</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">qa_unique</span>
                        <span class="ow">and</span> <span class="n">QA_WATER</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">qa_unique</span>
                        <span class="ow">and</span> <span class="n">QA_SNOW</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">qa_unique</span>
                    <span class="p">):</span>
                        <span class="k">continue</span>

                    <span class="n">block_folder</span> <span class="o">=</span> <span class="s2">&quot;block_x</span><span class="si">{}</span><span class="s2">_y</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
                        <span class="n">join</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">block_folder</span><span class="p">),</span> <span class="n">file_name</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="n">B1_blocks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
                                <span class="n">B2_blocks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
                                <span class="n">B3_blocks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
                                <span class="n">B4_blocks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
                                <span class="n">B5_blocks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
                                <span class="n">B6_blocks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
                                <span class="n">B7_blocks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
                                <span class="n">QA_blocks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
                            <span class="p">]</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
                    <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
                <span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">([</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">b3</span><span class="p">,</span> <span class="n">b4</span><span class="p">,</span> <span class="n">b5</span><span class="p">,</span> <span class="n">b6</span><span class="p">,</span> <span class="n">b7</span><span class="p">,</span> <span class="n">QA_band_unpacked</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">int16</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="c1"># scene_list.append(folder_name)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># logger.info(&#39;Not enough clear observations for {}&#39;.format(folder[0:len(folder) - 3]))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;Not enough clear observations for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">])</span>
        <span class="p">)</span>

    <span class="c1"># delete unzip folder</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">),</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;SR&quot;</span><span class="p">,</span> <span class="s2">&quot;BT&quot;</span><span class="p">)),</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>



<div class="viewcode-block" id="single_image_stacking_collection2">
<a class="viewcode-back" href="../../../api/pyxccd.imagetool.prepare_ard.html#pyxccd.imagetool.prepare_ard.single_image_stacking_collection2">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">single_image_stacking_collection2</span><span class="p">(</span>
    <span class="n">tmp_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">source_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">out_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">clear_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">logger</span><span class="p">:</span> <span class="n">Logger</span><span class="p">,</span>
    <span class="n">dataset_info</span><span class="p">:</span> <span class="n">DatasetInfo</span><span class="p">,</span>
    <span class="n">reference_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">is_partition</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">low_date_bound</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">upp_date_bound</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">folder</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    for collection 2</span>
<span class="sd">    :param tmp_path: tmp folder to save unzip image</span>
<span class="sd">    :param source_dir: image folder save source zipped files</span>
<span class="sd">    :param out_dir: the folder to save result</span>
<span class="sd">    :param clear_threshold: threshold of clear pixel percentage, if lower than threshold, won&#39;t be processed</span>
<span class="sd">    :param logger: the handler of logger file</span>
<span class="sd">    :param dataset_info:DatasetInfo</span>
<span class="sd">    :param is_partition: True, partition each image into blocks; False, save original size of image</span>
<span class="sd">    :param low_date_bound: the lower bound of user interested date range</span>
<span class="sd">    :param upp_date_bound: the upper bound of user interested date range</span>
<span class="sd">    :param bounds</span>
<span class="sd">    :param folder: the folder name of image</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># unzip SR</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">)):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">),</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;.tar&quot;</span><span class="p">))</span> <span class="k">as</span> <span class="n">tar_ref</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tar_ref</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># logger.warning(&#39;Unzip fails for {}&#39;.format(folder))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unzip fails for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
                <span class="k">return</span>
    <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unzip fails for </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
        <span class="c1"># return</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">rio_warp</span><span class="p">(</span>
            <span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">_QA_PIXEL.TIF&quot;</span><span class="p">),</span>
            <span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;_tmp_img.tif&quot;</span><span class="p">),</span>
            <span class="n">reference_path</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">QA_band</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">_QA_PIXEL.TIF&quot;</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># logger.error(&#39;Cannot open QA band for {}: {}&#39;.format(folder, e))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Cannot open QA band for </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="c1"># convertQA = np.vectorize(qabitval)</span>
    <span class="n">QA_band_unpacked</span> <span class="o">=</span> <span class="n">qabitval_array_c2</span><span class="p">(</span><span class="n">QA_band</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">short</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">clear_threshold</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">clear_ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">QA_band_unpacked</span> <span class="o">==</span> <span class="n">QA_CLEAR</span><span class="p">,</span> <span class="n">QA_band_unpacked</span> <span class="o">==</span> <span class="n">QA_WATER</span><span class="p">)</span>
        <span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">QA_band_unpacked</span> <span class="o">!=</span> <span class="n">QA_FILL</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">clear_ratio</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">clear_ratio</span> <span class="o">&gt;</span> <span class="n">clear_threshold</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">folder</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;5&quot;</span><span class="p">:</span>
            <span class="n">sensor</span> <span class="o">=</span> <span class="s2">&quot;LT5&quot;</span>
        <span class="k">elif</span> <span class="n">folder</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;7&quot;</span><span class="p">:</span>
            <span class="n">sensor</span> <span class="o">=</span> <span class="s2">&quot;LE7&quot;</span>
        <span class="k">elif</span> <span class="n">folder</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;8&quot;</span><span class="p">:</span>
            <span class="n">sensor</span> <span class="o">=</span> <span class="s2">&quot;LC8&quot;</span>
        <span class="k">elif</span> <span class="n">folder</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;9&quot;</span><span class="p">:</span>
            <span class="n">sensor</span> <span class="o">=</span> <span class="s2">&quot;LC9&quot;</span>
        <span class="k">elif</span> <span class="n">folder</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>
            <span class="n">sensor</span> <span class="o">=</span> <span class="s2">&quot;LT4&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Sensor is not correctly formatted for the scene </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">folder</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">13</span><span class="p">]</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">folder</span><span class="p">[</span><span class="mi">13</span><span class="p">:</span><span class="mi">16</span><span class="p">]</span>
        <span class="n">year</span> <span class="o">=</span> <span class="n">folder</span><span class="p">[</span><span class="mi">17</span><span class="p">:</span><span class="mi">21</span><span class="p">]</span>
        <span class="n">doy</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">folder</span><span class="p">[</span><span class="mi">21</span><span class="p">:</span><span class="mi">23</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">folder</span><span class="p">[</span><span class="mi">23</span><span class="p">:</span><span class="mi">25</span><span class="p">]))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%j&quot;</span><span class="p">)</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="s2">&quot;C2&quot;</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">folder</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">folder</span><span class="p">)]</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">sensor</span> <span class="o">+</span> <span class="n">path</span> <span class="o">+</span> <span class="n">row</span> <span class="o">+</span> <span class="n">year</span> <span class="o">+</span> <span class="n">doy</span> <span class="o">+</span> <span class="n">collection</span> <span class="o">+</span> <span class="n">version</span>
        <span class="k">if</span> <span class="n">low_date_bound</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">doy</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">parse</span><span class="p">(</span>
                <span class="n">low_date_bound</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">upp_date_bound</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">doy</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">parse</span><span class="p">(</span>
                <span class="n">upp_date_bound</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">sensor</span> <span class="o">==</span> <span class="s2">&quot;LT5&quot;</span> <span class="ow">or</span> <span class="n">sensor</span> <span class="o">==</span> <span class="s2">&quot;LE7&quot;</span> <span class="ow">or</span> <span class="n">sensor</span> <span class="o">==</span> <span class="s2">&quot;LT4&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># b1 = rio_loaddata(join(join(tmp_path, folder),</span>
                <span class="c1">#                               &quot;{}_SR_B1.TIF&quot;.format(folder)))</span>
                <span class="n">rio_warp</span><span class="p">(</span>
                    <span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">_SR_B1.TIF&quot;</span><span class="p">),</span>
                    <span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;_tmp_img.tif&quot;</span><span class="p">),</span>
                    <span class="n">reference_path</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">b1</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;_tmp_img.tif&quot;</span><span class="p">))</span>
                <span class="n">rio_warp</span><span class="p">(</span>
                    <span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">_SR_B2.TIF&quot;</span><span class="p">),</span>
                    <span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;_tmp_img.tif&quot;</span><span class="p">),</span>
                    <span class="n">reference_path</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">b2</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;_tmp_img.tif&quot;</span><span class="p">))</span>
                <span class="n">rio_warp</span><span class="p">(</span>
                    <span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">_SR_B3.TIF&quot;</span><span class="p">),</span>
                    <span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;_tmp_img.tif&quot;</span><span class="p">),</span>
                    <span class="n">reference_path</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">b3</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;_tmp_img.tif&quot;</span><span class="p">))</span>
                <span class="n">rio_warp</span><span class="p">(</span>
                    <span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">_SR_B4.TIF&quot;</span><span class="p">),</span>
                    <span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;_tmp_img.tif&quot;</span><span class="p">),</span>
                    <span class="n">reference_path</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">b4</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;_tmp_img.tif&quot;</span><span class="p">))</span>
                <span class="n">rio_warp</span><span class="p">(</span>
                    <span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">_SR_B5.TIF&quot;</span><span class="p">),</span>
                    <span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;_tmp_img.tif&quot;</span><span class="p">),</span>
                    <span class="n">reference_path</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">b5</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;_tmp_img.tif&quot;</span><span class="p">))</span>
                <span class="n">rio_warp</span><span class="p">(</span>
                    <span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">_SR_B7.TIF&quot;</span><span class="p">),</span>
                    <span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;_tmp_img.tif&quot;</span><span class="p">),</span>
                    <span class="n">reference_path</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">b6</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;_tmp_img.tif&quot;</span><span class="p">))</span>

                <span class="n">rio_warp</span><span class="p">(</span>
                    <span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">_ST_B6.TIF&quot;</span><span class="p">),</span>
                    <span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;_tmp_img.tif&quot;</span><span class="p">),</span>
                    <span class="n">reference_path</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">b7</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;_tmp_img.tif&quot;</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># logger.error(&#39;Cannot open spectral bands for {}: {}&#39;.format(folder, e))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Cannot open Landsat bands for </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                <span class="k">return</span>
        <span class="k">elif</span> <span class="n">sensor</span> <span class="o">==</span> <span class="s2">&quot;LC8&quot;</span> <span class="ow">or</span> <span class="s2">&quot;LC9&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">rio_warp</span><span class="p">(</span>
                    <span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">_SR_B2.TIF&quot;</span><span class="p">),</span>
                    <span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;_tmp_img.tif&quot;</span><span class="p">),</span>
                    <span class="n">reference_path</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">b1</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;_tmp_img.tif&quot;</span><span class="p">))</span>
                <span class="n">rio_warp</span><span class="p">(</span>
                    <span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">_SR_B3.TIF&quot;</span><span class="p">),</span>
                    <span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;_tmp_img.tif&quot;</span><span class="p">),</span>
                    <span class="n">reference_path</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">b2</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;_tmp_img.tif&quot;</span><span class="p">))</span>
                <span class="n">rio_warp</span><span class="p">(</span>
                    <span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">_SR_B4.TIF&quot;</span><span class="p">),</span>
                    <span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;_tmp_img.tif&quot;</span><span class="p">),</span>
                    <span class="n">reference_path</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">b3</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;_tmp_img.tif&quot;</span><span class="p">))</span>
                <span class="n">rio_warp</span><span class="p">(</span>
                    <span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">_SR_B5.TIF&quot;</span><span class="p">),</span>
                    <span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;_tmp_img.tif&quot;</span><span class="p">),</span>
                    <span class="n">reference_path</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">b4</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;_tmp_img.tif&quot;</span><span class="p">))</span>
                <span class="n">rio_warp</span><span class="p">(</span>
                    <span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">_SR_B6.TIF&quot;</span><span class="p">),</span>
                    <span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;_tmp_img.tif&quot;</span><span class="p">),</span>
                    <span class="n">reference_path</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">b5</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;_tmp_img.tif&quot;</span><span class="p">))</span>
                <span class="n">rio_warp</span><span class="p">(</span>
                    <span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">_SR_B7.TIF&quot;</span><span class="p">),</span>
                    <span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;_tmp_img.tif&quot;</span><span class="p">),</span>
                    <span class="n">reference_path</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">b6</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;_tmp_img.tif&quot;</span><span class="p">))</span>

                <span class="n">rio_warp</span><span class="p">(</span>
                    <span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">_ST_B10.TIF&quot;</span><span class="p">),</span>
                    <span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;_tmp_img.tif&quot;</span><span class="p">),</span>
                    <span class="n">reference_path</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">b7</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;_tmp_img.tif&quot;</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># logger.error(&#39;Cannot open spectral bands for {}: {}&#39;.format(folder, e))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot open Landsat bands for </span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">b1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">b2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">b3</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">b4</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">b5</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">b6</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">b7</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Reading Landsat band fails for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="c1"># source: https://www.usgs.gov/faqs/how-do-i-use-scale-factor-landsat-level-2-science-products?qt-</span>
        <span class="c1"># news_science_products=0#qt-news_science_products recommended by yongquan</span>
        <span class="n">B1_t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10000</span> <span class="o">*</span> <span class="p">(</span><span class="n">b1</span> <span class="o">*</span> <span class="mf">2.75e-05</span> <span class="o">-</span> <span class="mf">0.2</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
        <span class="n">B2_t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10000</span> <span class="o">*</span> <span class="p">(</span><span class="n">b2</span> <span class="o">*</span> <span class="mf">2.75e-05</span> <span class="o">-</span> <span class="mf">0.2</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
        <span class="n">B3_t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10000</span> <span class="o">*</span> <span class="p">(</span><span class="n">b3</span> <span class="o">*</span> <span class="mf">2.75e-05</span> <span class="o">-</span> <span class="mf">0.2</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
        <span class="n">B4_t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10000</span> <span class="o">*</span> <span class="p">(</span><span class="n">b4</span> <span class="o">*</span> <span class="mf">2.75e-05</span> <span class="o">-</span> <span class="mf">0.2</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
        <span class="n">B5_t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10000</span> <span class="o">*</span> <span class="p">(</span><span class="n">b5</span> <span class="o">*</span> <span class="mf">2.75e-05</span> <span class="o">-</span> <span class="mf">0.2</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
        <span class="n">B7_t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10000</span> <span class="o">*</span> <span class="p">(</span><span class="n">b7</span> <span class="o">*</span> <span class="mf">2.75e-05</span> <span class="o">-</span> <span class="mf">0.2</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
        <span class="n">B6_t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="p">(</span><span class="n">b6</span> <span class="o">*</span> <span class="mf">0.00341802</span> <span class="o">+</span> <span class="mi">149</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>

        <span class="c1"># padding zeros</span>
        <span class="n">b1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">dataset_info</span><span class="o">.</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
        <span class="n">b1</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">B1_t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">B1_t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">B1_t</span>
        <span class="n">b2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">dataset_info</span><span class="o">.</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
        <span class="n">b2</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">B1_t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">B1_t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">B2_t</span>
        <span class="n">b3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">dataset_info</span><span class="o">.</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
        <span class="n">b3</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">B1_t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">B1_t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">B3_t</span>
        <span class="n">b4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">dataset_info</span><span class="o">.</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
        <span class="n">b4</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">B1_t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">B1_t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">B4_t</span>
        <span class="n">b5</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">dataset_info</span><span class="o">.</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
        <span class="n">b5</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">B1_t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">B1_t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">B5_t</span>
        <span class="n">b6</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">dataset_info</span><span class="o">.</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
        <span class="n">b6</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">B1_t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">B1_t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">B6_t</span>
        <span class="n">b7</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">dataset_info</span><span class="o">.</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
        <span class="n">b7</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">B1_t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">B1_t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">B7_t</span>

        <span class="k">if</span> <span class="n">is_partition</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># width of a block</span>
            <span class="n">bytesize</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># short16 = 2 * byte</span>
            <span class="c1"># source: https://towardsdatascience.com/efficiently-splitting-an-image-into-tiles-</span>
            <span class="c1"># in-python-using-numpy-d1bf0dd7b6f7</span>
            <span class="n">B1_blocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span>
                <span class="n">b1</span><span class="p">,</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_y</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_x</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">strides</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">bytesize</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">B2_blocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span>
                <span class="n">b2</span><span class="p">,</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_y</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_x</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">strides</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">bytesize</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">B3_blocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span>
                <span class="n">b3</span><span class="p">,</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_y</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_x</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">strides</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">bytesize</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">B4_blocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span>
                <span class="n">b4</span><span class="p">,</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_y</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_x</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">strides</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">bytesize</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">B5_blocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span>
                <span class="n">b5</span><span class="p">,</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_y</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_x</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">strides</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">bytesize</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">B6_blocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span>
                <span class="n">b6</span><span class="p">,</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_y</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_x</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">strides</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">bytesize</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">B7_blocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span>
                <span class="n">b7</span><span class="p">,</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_y</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_x</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">strides</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">bytesize</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">QA_blocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span>
                <span class="n">QA_band_unpacked</span><span class="p">,</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_y</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_x</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">strides</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">bytesize</span><span class="p">,</span>
                    <span class="n">bytesize</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_y</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_x</span><span class="p">):</span>
                    <span class="c1"># check if no valid pixels in the chip, then eliminate</span>
                    <span class="n">qa_unique</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">QA_blocks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>

                    <span class="c1"># skip blocks are all cloud, shadow or filled values</span>
                    <span class="c1"># in DHTC, we also don&#39;t need to save pixel that has qa value of &#39;QA_CLOUD&#39;,</span>
                    <span class="c1"># &#39;QA_SHADOW&#39;, or FILLED value (255)</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">QA_CLEAR</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">qa_unique</span>
                        <span class="ow">and</span> <span class="n">QA_WATER</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">qa_unique</span>
                        <span class="ow">and</span> <span class="n">QA_SNOW</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">qa_unique</span>
                    <span class="p">):</span>
                        <span class="k">continue</span>

                    <span class="n">block_folder</span> <span class="o">=</span> <span class="s2">&quot;block_x</span><span class="si">{}</span><span class="s2">_y</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
                        <span class="n">join</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">block_folder</span><span class="p">),</span> <span class="n">file_name</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="n">B1_blocks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
                                <span class="n">B2_blocks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
                                <span class="n">B3_blocks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
                                <span class="n">B4_blocks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
                                <span class="n">B5_blocks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
                                <span class="n">B6_blocks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
                                <span class="n">B7_blocks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
                                <span class="n">QA_blocks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
                            <span class="p">]</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
                    <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
                <span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">([</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">b3</span><span class="p">,</span> <span class="n">b4</span><span class="p">,</span> <span class="n">b5</span><span class="p">,</span> <span class="n">b6</span><span class="p">,</span> <span class="n">b7</span><span class="p">,</span> <span class="n">QA_band_unpacked</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">int16</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="c1"># scene_list.append(folder_name)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># logger.info(&#39;Not enough clear observations for {}&#39;.format(folder[0:len(folder) - 3]))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;Not enough clear observations for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">])</span>
        <span class="p">)</span>

    <span class="c1"># delete unzip folder</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">),</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;SR&quot;</span><span class="p">,</span> <span class="s2">&quot;BT&quot;</span><span class="p">)),</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>



<div class="viewcode-block" id="checkfinished_step1">
<a class="viewcode-back" href="../../../api/pyxccd.imagetool.prepare_ard.html#pyxccd.imagetool.prepare_ard.checkfinished_step1">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">checkfinished_step1</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param tmp_path:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span></div>



<div class="viewcode-block" id="checkfinished_step2">
<a class="viewcode-back" href="../../../api/pyxccd.imagetool.prepare_ard.html#pyxccd.imagetool.prepare_ard.checkfinished_step2">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">checkfinished_step2</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">n_cores</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param out_dir:</span>
<span class="sd">    :param n_cores:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cores</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s2">&quot;rank</span><span class="si">{}</span><span class="s2">_finished.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))):</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span></div>



<div class="viewcode-block" id="checkfinished_step3_partition">
<a class="viewcode-back" href="../../../api/pyxccd.imagetool.prepare_ard.html#pyxccd.imagetool.prepare_ard.checkfinished_step3_partition">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">checkfinished_step3_partition</span><span class="p">(</span><span class="n">out_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param out_dir:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s2">&quot;starting_last_dates.txt&quot;</span><span class="p">)):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span></div>



<div class="viewcode-block" id="checkfinished_step3_nopartition">
<a class="viewcode-back" href="../../../api/pyxccd.imagetool.prepare_ard.html#pyxccd.imagetool.prepare_ard.checkfinished_step3_nopartition">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">checkfinished_step3_nopartition</span><span class="p">(</span><span class="n">out_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param out_dir:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s2">&quot;scene_list.txt&quot;</span><span class="p">)):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span></div>



<div class="viewcode-block" id="get_extent">
<a class="viewcode-back" href="../../../api/pyxccd.imagetool.prepare_ard.html#pyxccd.imagetool.prepare_ard.get_extent">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_extent</span><span class="p">(</span><span class="n">extent_geojson</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">buf</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    read shapefile of a tile from an S3 bucket, and convert projection to be aligned with sample image.</span>
<span class="sd">    arg:</span>
<span class="sd">        &#39;extent_geojson&#39;: sharply geojson object</span>
<span class="sd">        res: planet resolution</span>
<span class="sd">    return:</span>
<span class="sd">        (float, float, float, float), (int, int)) tuple</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># txmin = min([row[0] for row in extent_geojson[&#39;coordinates&#39;][0]]) - res / 2.0</span>
    <span class="c1"># txmax = max([row[0] for row in extent_geojson[&#39;coordinates&#39;][0]]) + res / 2.0</span>
    <span class="c1"># tymin = min([row[1] for row in extent_geojson[&#39;coordinates&#39;][0]]) - res / 2.0</span>
    <span class="c1"># tymax = max([row[1] for row in extent_geojson[&#39;coordinates&#39;][0]]) + res / 2.0</span>
    <span class="n">txmin</span> <span class="o">=</span> <span class="n">extent_geojson</span><span class="p">[</span><span class="s2">&quot;bbox&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">res</span> <span class="o">*</span> <span class="n">buf</span>
    <span class="n">txmax</span> <span class="o">=</span> <span class="n">extent_geojson</span><span class="p">[</span><span class="s2">&quot;bbox&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">res</span> <span class="o">*</span> <span class="n">buf</span>
    <span class="n">tymin</span> <span class="o">=</span> <span class="n">extent_geojson</span><span class="p">[</span><span class="s2">&quot;bbox&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">res</span> <span class="o">*</span> <span class="n">buf</span>
    <span class="n">tymax</span> <span class="o">=</span> <span class="n">extent_geojson</span><span class="p">[</span><span class="s2">&quot;bbox&quot;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">res</span> <span class="o">*</span> <span class="n">buf</span>
    <span class="n">n_row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">tymax</span> <span class="o">-</span> <span class="n">tymin</span><span class="p">)</span> <span class="o">/</span> <span class="n">res</span><span class="p">)</span>
    <span class="n">n_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">txmax</span> <span class="o">-</span> <span class="n">txmin</span><span class="p">)</span> <span class="o">/</span> <span class="n">res</span><span class="p">)</span>
    <span class="n">txmin_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">txmin</span> <span class="o">+</span> <span class="n">txmax</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">n_col</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">res</span>
    <span class="n">txmax_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">txmin</span> <span class="o">+</span> <span class="n">txmax</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">n_col</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">res</span>
    <span class="n">tymin_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">tymin</span> <span class="o">+</span> <span class="n">tymax</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">n_row</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">res</span>
    <span class="n">tymax_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">tymin</span> <span class="o">+</span> <span class="n">tymax</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">n_row</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">res</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">txmin_new</span><span class="p">,</span> <span class="n">txmax_new</span><span class="p">,</span> <span class="n">tymin_new</span><span class="p">,</span> <span class="n">tymax_new</span><span class="p">),</span> <span class="p">(</span><span class="n">n_row</span><span class="p">,</span> <span class="n">n_col</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_feature">
<a class="viewcode-back" href="../../../api/pyxccd.imagetool.prepare_ard.html#pyxccd.imagetool.prepare_ard.get_feature">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_feature</span><span class="p">(</span><span class="n">shp</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">shp</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">feature</span></div>



<div class="viewcode-block" id="explode">
<a class="viewcode-back" href="../../../api/pyxccd.imagetool.prepare_ard.html#pyxccd.imagetool.prepare_ard.explode">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">explode</span><span class="p">(</span><span class="n">coords</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Explode a GeoJSON geometry&#39;s coordinates object and yield coordinate tuples.</span>
<span class="sd">    As long as the input is conforming, the type of the geometry doesn&#39;t matter.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
            <span class="k">yield</span> <span class="n">coords</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">explode</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">f</span></div>



<div class="viewcode-block" id="bbox">
<a class="viewcode-back" href="../../../api/pyxccd.imagetool.prepare_ard.html#pyxccd.imagetool.prepare_ard.bbox">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">bbox</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="n">explode</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">][</span><span class="s2">&quot;coordinates&quot;</span><span class="p">])))</span>
    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">y</span><span class="p">)</span></div>



<span class="nd">@click</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s2">&quot;--source_dir&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;the folder directory of Landsat tar files &quot;</span> <span class="s2">&quot;downloaded from USGS website&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s2">&quot;--out_dir&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;the folder directory for storing stacks&quot;</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s2">&quot;--clear_threshold&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;threshold of clear pixel percentage for a tile, if lower than threshold, won&#39;t be processed&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s2">&quot;--single_path&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;indicate if using single_path or sidelap&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--rank&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;the rank id&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--n_cores&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;the total cores assigned&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s2">&quot;--is_partition/--continuous&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;partition the output to blocks&quot;</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--yaml_path&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;yaml file path&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s2">&quot;--hpc/--dhtc&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;if it is set for HPC or DHTC environment&quot;</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s2">&quot;--low_date_bound&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;the lower bound of the date range of user interest&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s2">&quot;--upp_date_bound&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;the upper bound of the date range of user interest&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s2">&quot;--collection&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Choice</span><span class="p">([</span><span class="s2">&quot;ARD&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="s2">&quot;HLS&quot;</span><span class="p">,</span> <span class="s2">&quot;HLS14&quot;</span><span class="p">,</span> <span class="s2">&quot;ARD-C2&quot;</span><span class="p">]),</span>
    <span class="n">default</span><span class="o">=</span><span class="s2">&quot;C2&quot;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;image source category&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span>
    <span class="n">source_dir</span><span class="p">,</span>
    <span class="n">out_dir</span><span class="p">,</span>
    <span class="n">clear_threshold</span><span class="p">,</span>
    <span class="n">single_path</span><span class="p">,</span>
    <span class="n">rank</span><span class="p">,</span>
    <span class="n">n_cores</span><span class="p">,</span>
    <span class="n">is_partition</span><span class="p">,</span>
    <span class="n">yaml_path</span><span class="p">,</span>
    <span class="n">hpc</span><span class="p">,</span>
    <span class="n">low_date_bound</span><span class="p">,</span>
    <span class="n">upp_date_bound</span><span class="p">,</span>
    <span class="n">collection</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">source_dir</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Source directory not exists!&quot;</span><span class="p">)</span>

    <span class="c1"># select only _SR</span>
    <span class="k">if</span> <span class="n">collection</span> <span class="o">==</span> <span class="s2">&quot;ARD&quot;</span> <span class="ow">or</span> <span class="n">collection</span> <span class="o">==</span> <span class="s2">&quot;ARD-C2&quot;</span><span class="p">:</span>
        <span class="n">folder_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">f</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">listdir</span><span class="p">(</span><span class="n">source_dir</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">isfile</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
                <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.tar&quot;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">f</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">-</span> <span class="mi">6</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;SR&quot;</span>
            <span class="p">)</span>
        <span class="p">]</span>
    <span class="k">elif</span> <span class="n">collection</span> <span class="o">==</span> <span class="s2">&quot;C2&quot;</span><span class="p">:</span>
        <span class="n">folder_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">f</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">listdir</span><span class="p">(</span><span class="n">source_dir</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">isfile</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.tar&quot;</span><span class="p">))</span>
        <span class="p">]</span>
    <span class="k">elif</span> <span class="n">collection</span> <span class="o">==</span> <span class="s2">&quot;HLS&quot;</span><span class="p">:</span>
        <span class="n">folder_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">listdir</span><span class="p">(</span><span class="n">source_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;HLS&quot;</span><span class="p">)]</span>
    <span class="k">elif</span> <span class="n">collection</span> <span class="o">==</span> <span class="s2">&quot;HLS14&quot;</span><span class="p">:</span>
        <span class="n">folder_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">y</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">source_dir</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;*.hdf&quot;</span><span class="p">))</span>
        <span class="p">]</span>

    <span class="n">tmp_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s2">&quot;tmp</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rank</span><span class="p">))</span>

    <span class="n">tz</span> <span class="o">=</span> <span class="n">timezone</span><span class="p">(</span><span class="s2">&quot;US/Eastern&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">yaml_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">yaml_obj</span><span class="p">:</span>
        <span class="n">config_general</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">yaml_obj</span><span class="p">)</span>

    <span class="n">dataset_info</span> <span class="o">=</span> <span class="n">class_from_dict</span><span class="p">(</span><span class="n">DatasetInfo</span><span class="p">,</span> <span class="n">config_general</span><span class="p">[</span><span class="s2">&quot;DATASETINFO&quot;</span><span class="p">])</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># adjust row and columns if they are not divisible by block height and width</span>
    <span class="k">if</span> <span class="n">collection</span> <span class="o">==</span> <span class="s2">&quot;C2&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="s2">&quot;ref_folder&quot;</span><span class="p">)):</span>
            <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="n">folder_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.tar&quot;</span><span class="p">))</span> <span class="k">as</span> <span class="n">tar_ref</span><span class="p">:</span>
                <span class="n">tar_ref</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="s2">&quot;ref_folder&quot;</span><span class="p">))</span>
        <span class="n">ref_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="s2">&quot;ref_folder&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_SR_B1.TIF&quot;</span><span class="p">)</span>
        <span class="n">ref_image</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span><span class="n">ref_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ref_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_y</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">ref_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="p">)</span>
            <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_rows</span> <span class="o">=</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span> <span class="o">*</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_y</span>

        <span class="k">if</span> <span class="n">ref_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">%</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_x</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">ref_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="p">)</span>
            <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">=</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span> <span class="o">*</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_x</span>
        <span class="n">ref_image</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># create needed folders</span>
    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># mode = w enables the log file to be overwritten</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s2">&quot;prepare_ard.log&quot;</span><span class="p">),</span>
            <span class="n">filemode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span>
            <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;AutoPrepareDataARD starts: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># create folder</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># if the nrows are divisible by block_height, need to adjust dataset info</span>
        <span class="k">if</span> <span class="n">collection</span> <span class="o">==</span> <span class="s2">&quot;C2&quot;</span><span class="p">:</span>
            <span class="n">ref_image</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span><span class="n">ref_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ref_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_y</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">ref_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="p">)</span>
                <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_rows</span> <span class="o">=</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_height</span> <span class="o">*</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_y</span>

            <span class="k">if</span> <span class="n">ref_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">%</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_x</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">ref_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="p">)</span>
                <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">=</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">block_width</span> <span class="o">*</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_x</span>
            <span class="n">ref_image</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">is_partition</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_y</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dataset_info</span><span class="o">.</span><span class="n">n_block_x</span><span class="p">):</span>
                    <span class="n">Path</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;block_x</span><span class="si">{</span><span class="n">j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">_y</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span>
                        <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>

        <span class="k">if</span> <span class="n">collection</span> <span class="o">==</span> <span class="s2">&quot;ARD&quot;</span> <span class="ow">or</span> <span class="n">collection</span> <span class="o">==</span> <span class="s2">&quot;ARD-C2&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">hpc</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="n">folder_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.tar&quot;</span><span class="p">))</span> <span class="k">as</span> <span class="n">tar_ref</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">tar_ref</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unzip fails for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">collection</span> <span class="o">==</span> <span class="s2">&quot;ARD&quot;</span><span class="p">:</span>
                    <span class="n">ref_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span>
                        <span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">b1.tif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ref_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span>
                        <span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_B1.TIF&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="p">)</span>

                <span class="c1"># warp a tile-based single path tif</span>
                <span class="k">with</span> <span class="n">importlib_resources</span><span class="o">.</span><span class="n">path</span><span class="p">(</span>
                    <span class="s2">&quot;pyxccd.imagetool&quot;</span><span class="p">,</span> <span class="s2">&quot;singlepath_landsat_conus.tif&quot;</span>
                <span class="p">)</span> <span class="k">as</span> <span class="n">conus_image_fpath</span><span class="p">:</span>
                    <span class="c1"># conus_image_fpath = (Path(__file__).parent / &#39;singlepath_landsat_conus.tif&#39;).resolve()</span>
                    <span class="n">rio_warp</span><span class="p">(</span>
                        <span class="n">conus_image_fpath</span><span class="p">,</span>
                        <span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s2">&quot;singlepath_landsat_tile.tif&quot;</span><span class="p">),</span>
                        <span class="n">ref_path</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">folder_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">ordinal_dates</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">toordinal</span><span class="p">(</span>
                        <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span>
                            <span class="nb">int</span><span class="p">(</span><span class="n">folder</span><span class="p">[</span><span class="mi">15</span><span class="p">:</span><span class="mi">19</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">folder</span><span class="p">[</span><span class="mi">19</span><span class="p">:</span><span class="mi">21</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">folder</span><span class="p">[</span><span class="mi">21</span><span class="p">:</span><span class="mi">23</span><span class="p">])</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folder_list</span>
                <span class="p">]</span>
        <span class="k">elif</span> <span class="n">collection</span> <span class="o">==</span> <span class="s2">&quot;C2&quot;</span><span class="p">:</span>
            <span class="n">ordinal_dates</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">toordinal</span><span class="p">(</span>
                    <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span>
                        <span class="nb">int</span><span class="p">(</span><span class="n">folder</span><span class="p">[</span><span class="mi">17</span><span class="p">:</span><span class="mi">21</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">folder</span><span class="p">[</span><span class="mi">21</span><span class="p">:</span><span class="mi">23</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">folder</span><span class="p">[</span><span class="mi">23</span><span class="p">:</span><span class="mi">25</span><span class="p">])</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folder_list</span>
            <span class="p">]</span>
        <span class="k">elif</span> <span class="n">collection</span> <span class="o">==</span> <span class="s2">&quot;HLS&quot;</span><span class="p">:</span>
            <span class="n">ordinal_dates</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">toordinal</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">folder</span><span class="p">[</span><span class="mi">15</span><span class="p">:</span><span class="mi">19</span><span class="p">]),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">folder</span><span class="p">[</span><span class="mi">19</span><span class="p">:</span><span class="mi">22</span><span class="p">])</span>
                <span class="o">-</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folder_list</span>
            <span class="p">]</span>
        <span class="k">elif</span> <span class="n">collection</span> <span class="o">==</span> <span class="s2">&quot;HLS14&quot;</span><span class="p">:</span>
            <span class="n">ordinal_dates</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">toordinal</span><span class="p">(</span>
                    <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">folder</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">15</span><span class="p">:</span><span class="mi">19</span><span class="p">]),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">folder</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">19</span><span class="p">:</span><span class="mi">22</span><span class="p">])</span>
                <span class="o">-</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folder_list</span>
            <span class="p">]</span>
        <span class="n">ordinal_dates</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span>
            <span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s2">&quot;starting_last_dates.txt&quot;</span><span class="p">),</span> <span class="s2">&quot;w+&quot;</span>
        <span class="p">)</span>  <span class="c1"># need to save out starting and</span>
        <span class="c1"># lasting date for this tile</span>
        <span class="k">if</span> <span class="n">low_date_bound</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">toordinal</span><span class="p">(</span><span class="n">parse</span><span class="p">(</span><span class="n">low_date_bound</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">file</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">ordinal_dates</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tmp</span><span class="p">]))))</span>
        <span class="k">if</span> <span class="n">upp_date_bound</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">toordinal</span><span class="p">(</span><span class="n">parse</span><span class="p">(</span><span class="n">upp_date_bound</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="mi">999999</span>
        <span class="n">file</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">ordinal_dates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">tmp</span><span class="p">]))))</span>
        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># mode = w enables the log file to be overwritten</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s2">&quot;prepare_ard.log&quot;</span><span class="p">),</span>
            <span class="n">filemode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span>
            <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="c1"># use starting_last_dates.txt to indicate all folder have been created. Very stupid way. Need improve it in future.</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">checkfinished_step1</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s2">&quot;starting_last_dates.txt&quot;</span><span class="p">)):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="c1"># read a general path file which can indicate which pixel is assigned to which path</span>
    <span class="n">path_array</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">single_path</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">collection</span> <span class="o">==</span> <span class="s2">&quot;ARD&quot;</span> <span class="ow">or</span> <span class="n">collection</span> <span class="o">==</span> <span class="s2">&quot;ARD-C2&quot;</span><span class="p">:</span>
            <span class="c1"># parse tile h and v from folder name</span>
            <span class="n">folder_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">source_dir</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hpc</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">path_array</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s2">&quot;singlepath_landsat_tile.tif&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">tile_h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                        <span class="n">folder_name</span><span class="p">[</span>
                            <span class="n">folder_name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;h&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">folder_name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;h&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">tile_v</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                        <span class="n">folder_name</span><span class="p">[</span>
                            <span class="n">folder_name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;v&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">folder_name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;v&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">path_array</span> <span class="o">=</span> <span class="n">rio_loaddata</span><span class="p">(</span>
                        <span class="n">join</span><span class="p">(</span>
                            <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
                            <span class="s2">&quot;singlepath_landsat_tile_crop_compress.tif&quot;</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="n">xoff</span><span class="o">=</span><span class="n">tile_h</span> <span class="o">*</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span><span class="p">,</span>
                        <span class="n">yoff</span><span class="o">=</span><span class="n">tile_v</span> <span class="o">*</span> <span class="n">dataset_info</span><span class="o">.</span><span class="n">n_rows</span><span class="p">,</span>
                        <span class="n">xsize</span><span class="o">=</span><span class="n">dataset_info</span><span class="o">.</span><span class="n">n_cols</span><span class="p">,</span>
                        <span class="n">ysize</span><span class="o">=</span><span class="n">dataset_info</span><span class="o">.</span><span class="n">n_rows</span><span class="p">,</span>
                    <span class="p">)</span>  <span class="c1"># read a partial array</span>
                    <span class="c1"># from a large file</span>
                <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="n">exit</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">collection</span> <span class="o">==</span> <span class="s2">&quot;C2&quot;</span><span class="p">:</span>
        <span class="c1"># gpd_tile = gpd.read_file(shapefile_path)</span>

        <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">n_cores</span><span class="p">)</span>
        <span class="n">single_image_stacking_collection2_partial</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
            <span class="n">single_image_stacking_collection2</span><span class="p">,</span>
            <span class="n">tmp_path</span><span class="p">,</span>
            <span class="n">source_dir</span><span class="p">,</span>
            <span class="n">out_dir</span><span class="p">,</span>
            <span class="n">clear_threshold</span><span class="p">,</span>
            <span class="n">logger</span><span class="p">,</span>
            <span class="n">dataset_info</span><span class="p">,</span>
            <span class="n">ref_path</span><span class="p">,</span>
            <span class="n">is_partition</span><span class="p">,</span>
            <span class="n">low_date_bound</span><span class="p">,</span>
            <span class="n">upp_date_bound</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">single_image_stacking_collection2_partial</span><span class="p">,</span> <span class="n">folder_list</span><span class="p">)</span>

        <span class="c1"># for i in range(int(np.ceil(len(folder_list) / n_cores))):</span>
        <span class="c1">#     new_rank = rank - 1 + i * n_cores</span>
        <span class="c1">#     # means that all folder has been processed</span>
        <span class="c1">#     if new_rank &gt; (len(folder_list) - 1):</span>
        <span class="c1">#         break</span>
        <span class="c1">#     folder = folder_list[new_rank]</span>
        <span class="c1">#     single_image_stacking_collection2(</span>
        <span class="c1">#         tmp_path,</span>
        <span class="c1">#         source_dir,</span>
        <span class="c1">#         out_dir,</span>
        <span class="c1">#         clear_threshold,</span>
        <span class="c1">#         logger,</span>
        <span class="c1">#         dataset_info,</span>
        <span class="c1">#         ref_path,</span>
        <span class="c1">#         is_partition=is_partition,</span>
        <span class="c1">#         low_date_bound=low_date_bound,</span>
        <span class="c1">#         upp_date_bound=upp_date_bound,</span>
        <span class="c1">#         folder</span>
        <span class="c1">#     )</span>
    <span class="k">elif</span> <span class="n">collection</span> <span class="o">==</span> <span class="s2">&quot;ARD&quot;</span> <span class="ow">or</span> <span class="n">collection</span> <span class="o">==</span> <span class="s2">&quot;ARD-C2&quot;</span><span class="p">:</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">n_cores</span><span class="p">)</span>
        <span class="n">single_image_stacking_partial</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
            <span class="n">single_image_stacking</span><span class="p">,</span>
            <span class="n">tmp_path</span><span class="p">,</span>
            <span class="n">source_dir</span><span class="p">,</span>
            <span class="n">out_dir</span><span class="p">,</span>
            <span class="n">clear_threshold</span><span class="p">,</span>
            <span class="n">path_array</span><span class="p">,</span>
            <span class="n">logger</span><span class="p">,</span>
            <span class="n">dataset_info</span><span class="p">,</span>
            <span class="n">is_partition</span><span class="p">,</span>
            <span class="n">low_date_bound</span><span class="p">,</span>
            <span class="n">upp_date_bound</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">single_image_stacking_partial</span><span class="p">,</span> <span class="n">folder_list</span><span class="p">)</span>

        <span class="c1"># assign files to each core</span>
        <span class="c1"># for i in range(int(np.ceil(len(folder_list) / n_cores))):</span>
        <span class="c1">#     new_rank = rank - 1 + i * n_cores</span>
        <span class="c1">#     # means that all folder has been processed</span>
        <span class="c1">#     if new_rank &gt; (len(folder_list) - 1):</span>
        <span class="c1">#         break</span>
        <span class="c1">#     folder = folder_list[new_rank]</span>
        <span class="c1">#     single_image_stacking(</span>
        <span class="c1">#         tmp_path,</span>
        <span class="c1">#         source_dir,</span>
        <span class="c1">#         out_dir,</span>
        <span class="c1">#         folder,</span>
        <span class="c1">#         clear_threshold,</span>
        <span class="c1">#         path_array,</span>
        <span class="c1">#         logger,</span>
        <span class="c1">#         dataset_info,</span>
        <span class="c1">#         is_partition=is_partition,</span>
        <span class="c1">#         low_date_bound=low_date_bound,</span>
        <span class="c1">#         upp_date_bound=upp_date_bound,</span>
        <span class="c1">#     )</span>
    <span class="k">elif</span> <span class="n">collection</span> <span class="o">==</span> <span class="s2">&quot;HLS&quot;</span><span class="p">:</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">n_cores</span><span class="p">)</span>
        <span class="n">single_image_stacking_hls_partial</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
            <span class="n">single_image_stacking_hls</span><span class="p">,</span>
            <span class="n">source_dir</span><span class="p">,</span>
            <span class="n">out_dir</span><span class="p">,</span>
            <span class="n">logger</span><span class="p">,</span>
            <span class="n">dataset_info</span><span class="p">,</span>
            <span class="n">clear_threshold</span><span class="p">,</span>
            <span class="n">is_partition</span><span class="p">,</span>
            <span class="n">low_date_bound</span><span class="p">,</span>
            <span class="n">upp_date_bound</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">single_image_stacking_hls_partial</span><span class="p">,</span> <span class="n">folder_list</span><span class="p">)</span>
        <span class="c1"># assign files to each core</span>
        <span class="c1"># for i in range(int(np.ceil(len(folder_list) / n_cores))):</span>
        <span class="c1">#     new_rank = rank - 1 + i * n_cores</span>
        <span class="c1">#     # means that all folder has been processed</span>
        <span class="c1">#     if new_rank &gt; (len(folder_list) - 1):</span>
        <span class="c1">#         break</span>
        <span class="c1">#     folder = folder_list[new_rank]</span>
        <span class="c1">#     single_image_stacking_hls(</span>
        <span class="c1">#         source_dir,</span>
        <span class="c1">#         out_dir,</span>
        <span class="c1">#         logger,</span>
        <span class="c1">#         dataset_info,</span>
        <span class="c1">#         folder,</span>
        <span class="c1">#         clear_threshold=clear_threshold,</span>
        <span class="c1">#         is_partition=is_partition,</span>
        <span class="c1">#         low_date_bound=low_date_bound,</span>
        <span class="c1">#         upp_date_bound=upp_date_bound,</span>
        <span class="c1">#     )</span>
    <span class="c1"># elif collection == &quot;HLS14&quot;:</span>
    <span class="c1">#     pool = Pool(n_cores)</span>
    <span class="c1">#     single_image_stacking_hls14_partial = functools.partial(</span>
    <span class="c1">#         single_image_stacking_hls, out_dir,</span>
    <span class="c1">#             logger,</span>
    <span class="c1">#             dataset_info,</span>
    <span class="c1">#             clear_threshold,</span>
    <span class="c1">#             is_partition,</span>
    <span class="c1">#             low_date_bound,</span>
    <span class="c1">#             upp_date_bound</span>
    <span class="c1">#     )</span>
    <span class="c1">#     pool.map(single_image_stacking_hls14_partial,  folder_list)</span>
    <span class="c1"># assign files to each core</span>
    <span class="c1"># for i in range(int(np.ceil(len(folder_list) / n_cores))):</span>
    <span class="c1">#     new_rank = rank - 1 + i * n_cores</span>
    <span class="c1">#     # means that all folder has been processed</span>
    <span class="c1">#     if new_rank &gt; (len(folder_list) - 1):</span>
    <span class="c1">#         break</span>
    <span class="c1">#     folder = folder_list[new_rank]</span>
    <span class="c1">#     single_image_stacking_hls14(</span>
    <span class="c1">#         out_dir,</span>
    <span class="c1">#         logger,</span>
    <span class="c1">#         dataset_info,</span>
    <span class="c1">#         folder,</span>
    <span class="c1">#         clear_threshold=clear_threshold,</span>
    <span class="c1">#         is_partition=is_partition,</span>
    <span class="c1">#         low_date_bound=low_date_bound,</span>
    <span class="c1">#         upp_date_bound=upp_date_bound,</span>
    <span class="c1">#     )</span>
    <span class="c1"># create an empty file for signaling the core that has been finished</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s2">&quot;rank</span><span class="si">{}</span><span class="s2">_finished.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rank</span><span class="p">)),</span> <span class="s2">&quot;w&quot;</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="c1"># wait for other cores assigned</span>
    <span class="c1"># while not checkfinished_step2(out_dir, n_cores):</span>
    <span class="c1">#     time.sleep(5)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># create scene list after stacking is finished and remove folders. Not need it in DHTC</span>
    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># remove tmp folder</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Stacking procedure finished: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Su Ye.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>