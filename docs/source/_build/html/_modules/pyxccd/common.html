

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pyxccd.common &mdash; pyxccd  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />

  
      <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            pyxccd
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial_en.html">Pyxccd Tutorial(English)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial_ch.html">Pyxccd指南(Chinese)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/pyxccd.html">Pyxccd API reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pyxccd</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">pyxccd.common</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pyxccd.common</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">make_dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span>

<span class="n">SCCD_CONSE_OUTPUT</span> <span class="o">=</span> <span class="mi">8</span>  <span class="c1"># the default outputted observation number once S-CCD detects breakpoint or anomaly, note it is not the conse for identifying breakpoints/anomalys</span>
<span class="n">NRT_BAND</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># the default S-CCD band number</span>
<span class="n">SCCD_NUM_C</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># the S-CCD harmonic model coefficient number</span>
<span class="n">FLEX_SCCD_NUM_C</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">COLD_NUM_C</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">TOTAL_BAND_FLEX</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># the maximum band input for flexible mode of COLD</span>
<span class="n">TOTAL_BAND_FLEX_NRT</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># the maximum band input for flexible mode of S-CCD</span>
<span class="n">SLOPE_SCALE</span> <span class="o">=</span> <span class="mi">10000</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_dtype_to_dataclass</span><span class="p">(</span><span class="n">dtype</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">class_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">type</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts a NumPy dtype to a dataclass.</span>

<span class="sd">    Args:</span>
<span class="sd">        dtype: The NumPy dtype to convert.</span>
<span class="sd">        class_name: The name of the generated dataclass.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A new dataclass type representing the structure of the dtype.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">fields</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">subtype</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span> <span class="ow">in</span> <span class="n">dtype</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">Any</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># Use Any for simplicity, or map subtypes to Python types</span>

    <span class="k">return</span> <span class="n">make_dataclass</span><span class="p">(</span><span class="n">class_name</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>


<span class="n">reccg_dt</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;t_start&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;t_end&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;t_break&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;pos&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;num_obs&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;change_prob&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;coefs&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">)),</span>
        <span class="p">(</span><span class="s2">&quot;rmse&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;magnitude&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>


<span class="n">sccd_dt</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;t_start&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;t_break&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;num_obs&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;coefs&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="n">NRT_BAND</span><span class="p">,</span> <span class="n">SCCD_NUM_C</span><span class="p">)),</span>
        <span class="p">(</span><span class="s2">&quot;rmse&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">NRT_BAND</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;magnitude&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">NRT_BAND</span><span class="p">),</span>
    <span class="p">],</span>
    <span class="n">align</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># sccd_dt.__doc__ = &quot;&quot;&quot;</span>
<span class="c1"># historical temporal segment info obtained from S-CCD algorithm as a structured array, a composition of simple datatypes:</span>

<span class="c1">#     t_start: int</span>
<span class="c1">#         ordinal date when series model gets started</span>
<span class="c1">#     t_break: int</span>
<span class="c1">#         ordinal date when the structural break (change) is detected</span>
<span class="c1">#     pos: int</span>
<span class="c1">#         location of each time series model (i * n_row + j), e.g., the pos of (1000, 1) is 5000*1000+1</span>
<span class="c1">#     coefs: numpy.ndarray</span>
<span class="c1">#         2-d array of shape (nbands, ncoefs) to keep multispectral harmonic coefficients from the last lasso regression.</span>
<span class="c1">#         Spectral bands include blue, green, red, nir, swir1, swir2 (from  row 1 to 6); eight harmonic</span>
<span class="c1">#         coefficients include intercept, slope, cos_annual, sin_annual, cos_semi, sin_semi,</span>
<span class="c1">#         cos_trimodal, sin_trimodal (from col 1 to 6). Note the slope has been multiplied by</span>
<span class="c1">#         10000, S-CCD uses 6-coefs model and 6 spectral bands</span>
<span class="c1">#     rmse: numpy.ndarray</span>
<span class="c1">#         1-d array of shape (nbands,), multispectral RMSE of predicted and actiual observations</span>
<span class="c1">#     magntiude: numpy.ndarray</span>
<span class="c1">#         1-d array of shape (nbands,), multispectral median difference between model prediction and</span>
<span class="c1">#         observations of a window of conse observations following detected breakpoint</span>
<span class="c1"># &quot;&quot;&quot;</span>

<span class="n">nrtqueue_dt</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span>
    <span class="p">[(</span><span class="s2">&quot;clry&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">,</span> <span class="n">NRT_BAND</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;clrx_since1982&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">)],</span> <span class="n">align</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="n">nrtmodel_dt</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;t_start_since1982&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;num_obs&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;obs&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">,</span> <span class="p">(</span><span class="n">NRT_BAND</span><span class="p">,</span> <span class="n">SCCD_CONSE_OUTPUT</span><span class="p">)),</span>
        <span class="p">(</span><span class="s2">&quot;obs_date_since1982&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">,</span> <span class="n">SCCD_CONSE_OUTPUT</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;covariance&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="n">NRT_BAND</span><span class="p">,</span> <span class="mi">36</span><span class="p">)),</span>
        <span class="p">(</span><span class="s2">&quot;nrt_coefs&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="n">NRT_BAND</span><span class="p">,</span> <span class="n">SCCD_NUM_C</span><span class="p">)),</span>
        <span class="p">(</span><span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">NRT_BAND</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;rmse_sum&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span> <span class="n">NRT_BAND</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;norm_cm&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;cm_angle&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;anomaly_conse&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ubyte</span><span class="p">),</span>
    <span class="p">],</span>
    <span class="n">align</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>


<span class="n">anomaly_dt</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;t_break&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;coefs&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="n">NRT_BAND</span><span class="p">,</span> <span class="n">SCCD_NUM_C</span><span class="p">)),</span>
        <span class="p">(</span><span class="s2">&quot;obs&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">,</span> <span class="p">(</span><span class="n">NRT_BAND</span><span class="p">,</span> <span class="n">SCCD_CONSE_OUTPUT</span><span class="p">)),</span>
        <span class="p">(</span><span class="s2">&quot;obs_date_since1982&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">,</span> <span class="n">SCCD_CONSE_OUTPUT</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;norm_cm&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">,</span> <span class="n">SCCD_CONSE_OUTPUT</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;cm_angle&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">,</span> <span class="n">SCCD_CONSE_OUTPUT</span><span class="p">),</span>
    <span class="p">],</span>
    <span class="n">align</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">cold_dt_flex</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;t_start&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;t_end&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;t_break&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;pos&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;num_obs&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;change_prob&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;coefs&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="n">TOTAL_BAND_FLEX</span><span class="p">,</span> <span class="n">COLD_NUM_C</span><span class="p">)),</span>
        <span class="p">(</span><span class="s2">&quot;rmse&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">TOTAL_BAND_FLEX</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;magnitude&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">TOTAL_BAND_FLEX</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="c1"># the below is for sccd flex mode</span>


<span class="n">sccd_dt_flex</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;t_start&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;t_break&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;num_obs&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;coefs&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="n">TOTAL_BAND_FLEX_NRT</span><span class="p">,</span> <span class="n">FLEX_SCCD_NUM_C</span><span class="p">)),</span>
        <span class="p">(</span><span class="s2">&quot;rmse&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">TOTAL_BAND_FLEX_NRT</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;magnitude&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">TOTAL_BAND_FLEX_NRT</span><span class="p">),</span>
    <span class="p">],</span>
    <span class="n">align</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">nrtqueue_dt_flex</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span>
    <span class="p">[(</span><span class="s2">&quot;clry&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">,</span> <span class="n">TOTAL_BAND_FLEX_NRT</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;clrx_since1982&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">)],</span>
    <span class="n">align</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">nrtmodel_dt_flex</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;t_start_since1982&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;num_obs&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;obs&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">,</span> <span class="p">(</span><span class="n">TOTAL_BAND_FLEX_NRT</span><span class="p">,</span> <span class="n">SCCD_CONSE_OUTPUT</span><span class="p">)),</span>
        <span class="p">(</span><span class="s2">&quot;obs_date_since1982&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">,</span> <span class="n">SCCD_CONSE_OUTPUT</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;covariance&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="n">TOTAL_BAND_FLEX_NRT</span><span class="p">,</span> <span class="mi">64</span><span class="p">)),</span>
        <span class="p">(</span><span class="s2">&quot;nrt_coefs&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="n">TOTAL_BAND_FLEX_NRT</span><span class="p">,</span> <span class="n">FLEX_SCCD_NUM_C</span><span class="p">)),</span>
        <span class="p">(</span><span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">TOTAL_BAND_FLEX_NRT</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;rmse_sum&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span> <span class="n">TOTAL_BAND_FLEX_NRT</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;norm_cm&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;cm_angle&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;anomaly_conse&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ubyte</span><span class="p">),</span>
    <span class="p">],</span>
    <span class="n">align</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>


<span class="n">anomaly_dt_flex</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;t_break&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;coefs&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="n">TOTAL_BAND_FLEX_NRT</span><span class="p">,</span> <span class="n">FLEX_SCCD_NUM_C</span><span class="p">)),</span>
        <span class="p">(</span><span class="s2">&quot;obs&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">,</span> <span class="p">(</span><span class="n">TOTAL_BAND_FLEX_NRT</span><span class="p">,</span> <span class="n">SCCD_CONSE_OUTPUT</span><span class="p">)),</span>
        <span class="p">(</span><span class="s2">&quot;obs_date_since1982&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">,</span> <span class="n">SCCD_CONSE_OUTPUT</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;norm_cm&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">,</span> <span class="n">SCCD_CONSE_OUTPUT</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;cm_angle&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">,</span> <span class="n">SCCD_CONSE_OUTPUT</span><span class="p">),</span>
    <span class="p">],</span>
    <span class="n">align</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="DatasetInfo">
<a class="viewcode-back" href="../../api/pyxccd.common.html#pyxccd.common.DatasetInfo">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DatasetInfo</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Store information for the dataset to be processed&quot;&quot;&quot;</span>

    <span class="n">n_rows</span><span class="p">:</span> <span class="nb">int</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The number of rows&quot;&quot;&quot;</span>
    <span class="n">n_cols</span><span class="p">:</span> <span class="nb">int</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The number of columns&quot;&quot;&quot;</span>
    <span class="n">n_block_x</span><span class="p">:</span> <span class="nb">int</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The block number in x direction&quot;&quot;&quot;</span>
    <span class="n">n_block_y</span><span class="p">:</span> <span class="nb">int</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The block number in y direction&quot;&quot;&quot;</span>
    <span class="n">nblocks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The total block number, n_block_x * n_block_y&quot;&quot;&quot;</span>
    <span class="n">block_width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The width of a block, n_cols / n_block_x&quot;&quot;&quot;</span>
    <span class="n">block_height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The height of a block, n_rows / n_block_y&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;generate nblocks, block_width, and block_height  once the dataclass is initialized&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nblocks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_block_x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_block_y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cols</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_block_x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_rows</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_block_y</span><span class="p">)</span></div>



<span class="n">SccdOutput</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
    <span class="s2">&quot;SccdOutput&quot;</span><span class="p">,</span> <span class="s2">&quot;position rec_cg min_rmse nrt_mode nrt_model nrt_queue&quot;</span>
<span class="p">)</span>
<span class="n">SccdOutput</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;: A namedtuple of standard S-CCD ouputs&quot;</span>
<span class="n">SccdOutput</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;: int. Location of each time series model. </span><span class="se">\n</span><span class="s2"> The position is computed as (i * (n_row-1) + j), e.g., the pos of (1000, 1) is 5000*(1000-1)+1&quot;</span>
<span class="n">SccdOutput</span><span class="o">.</span><span class="n">rec_cg</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;: numpy.ndarray. 1-d structured array with :py:class:`rec_cg`. </span><span class="se">\n</span><span class="s2"> Historical temporal segment info were obtained from S-CCD algorithm as a structured array&quot;</span>
<span class="n">SccdOutput</span><span class="o">.</span><span class="n">min_rmse</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;: numpy.ndarray. 1-d array of shape (nbands,). </span><span class="se">\n</span><span class="s2"> The minimum RMSE  was obtained by temporal semivariogram. This array keeps fix with sccd_update since sccd_detect is first used.&quot;&quot;&quot;</span>
<span class="n">SccdOutput</span><span class="o">.</span><span class="n">nrt_mode</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;:int. </span><span class="se">\n</span>
<span class="s2">                                    (first digit) </span><span class="se">\n</span>
<span class="s2">                                    0 - has predictability </span><span class="se">\n</span>
<span class="s2">                                    1 - not has predictability </span><span class="se">\n</span>
<span class="s2">                                    (second digit) </span><span class="se">\n</span>
<span class="s2">                                    The current sccd operating mode for the pixel: </span><span class="se">\n</span>
<span class="s2">                                    0 - void mode, not intialized yet </span><span class="se">\n</span>
<span class="s2">                                    1 - monitoring mode </span><span class="se">\n</span>
<span class="s2">                                    2 - queue mode. Once the break is detected, the mode is transition from monitoring to queue mode </span><span class="se">\n</span>
<span class="s2">                                    3 - monitoring mode for snow </span><span class="se">\n</span>
<span class="s2">                                    4 - queue mode for snow </span><span class="se">\n</span>
<span class="s2">                                    5 - transition mode from monitoring to queue mode (keep nrt_model and nrt_queue both), keeping 15 days since the break is first detected&quot;&quot;&quot;</span>
<span class="n">SccdOutput</span><span class="o">.</span><span class="n">nrt_model</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;: numpy.ndarray. 1-d structured array with :py:class:`nrt_model` dtype </span><span class="se">\n</span><span class="s2"> </span>
<span class="s2">Current nrt model that will be used for NRT monitoring. Only valid for the monitoring modes (1/3/5/11) &quot;&quot;&quot;</span>
<span class="n">SccdOutput</span><span class="o">.</span><span class="n">nrt_queue</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;: numpy.ndarray. 1-d array of structured array with :py:class:`nrt_queue` dtype. </span><span class="se">\n</span><span class="s2"> </span>
<span class="s2">                                    Observation collection to build initialization model for queue modes (2/4/5). Collected the observations in the queue until the CCDC initialization successes.&quot;&quot;&quot;</span>


<span class="c1"># the below dataclass are created only for docstring purpose. Python so far doesn&#39;t support docstring for dtype yet.</span>
<div class="viewcode-block" id="cold_rec_cg">
<a class="viewcode-back" href="../../api/pyxccd.common.html#pyxccd.common.cold_rec_cg">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">cold_rec_cg</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;records of segments obtained from COLD algorithm as a structured array, a composition of simple datatypes&quot;&quot;&quot;</span>

    <span class="n">t_start</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ordinal date when series model gets started&quot;&quot;&quot;</span>

    <span class="n">t_end</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ordinal date when series model gets ended&quot;&quot;&quot;</span>

    <span class="n">t_break</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ordinal date when the structural break (change) is detected&quot;&quot;&quot;</span>

    <span class="n">pos</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Location of each time series model (i * n_row + j), e.g., the pos of (1000, 1) is 5000*1000+1&quot;&quot;&quot;</span>

    <span class="n">num_obs</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Number of clear observations used for model estimation&quot;&quot;&quot;</span>

    <span class="n">category</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Quality of the model estimation (what model is used, what process is used)</span>
<span class="sd">    </span>
<span class="sd">        (first digit)</span>
<span class="sd">        </span>
<span class="sd">        0 - normal model (no change)</span>
<span class="sd">        </span>
<span class="sd">        1 - change at the beginning of time series model</span>
<span class="sd">        </span>
<span class="sd">        2 - change at the end of time series model</span>
<span class="sd">        </span>
<span class="sd">        3 - disturbance change in the middle</span>
<span class="sd">        </span>
<span class="sd">        4 -  fmask fail scenario</span>
<span class="sd">        </span>
<span class="sd">        5 - permanent snow scenario</span>
<span class="sd">        </span>
<span class="sd">        6 - outside user mask</span>
<span class="sd">        </span>
<span class="sd">        (second digit)</span>
<span class="sd">        </span>
<span class="sd">        1 - model has only constant term</span>
<span class="sd">        </span>
<span class="sd">        4 - model has 3 coefs + 1 const</span>
<span class="sd">        </span>
<span class="sd">        6 - model has 5 coefs + 1 const</span>
<span class="sd">        </span>
<span class="sd">        8 - model has 7 coefs + 1 const</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">change_prob</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Probability of a pixel that have undergone change (between 0 and 100)&quot;&quot;&quot;</span>

    <span class="n">coefs</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;2-d array of shape (nbands, ncoefs). It keeps multispectral harmonic coefficients from the last lasso regression. If not flexible mode, the spectral bands are fix, including blue, green, red, nir, swir1, swir2, thermal (from row 1 to 7). If flexible mode, the rows follow the order of inputted bands.The columns correspond to the eight harmonic coefficients including intercept, slope, cos_annual, sin_annual, cos_semi, sin_semi, cos_trimodal, sin_trimodal (from col 1 to 8). Note that the slope has been multiplied by 10000.&quot;&quot;&quot;</span>

    <span class="n">rmse</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;1-d array of shape (nbands,), multispectral RMSE of predicted and actiual observations&quot;&quot;&quot;</span>

    <span class="n">magntiude</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;1-d array of shape (nbands,), multispectral median difference between model prediction and observations of a window of conse observations following detected breakpoint&quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="rec_cg">
<a class="viewcode-back" href="../../api/pyxccd.common.html#pyxccd.common.rec_cg">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">rec_cg</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;historical temporal segment info obtained from S-CCD algorithm as a structured array, a composition of simple datatypes&quot;&quot;&quot;</span>

    <span class="n">t_start</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ordinal date when series model gets started.&quot;&quot;&quot;</span>
    <span class="n">t_break</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ordinal date when the structural break (change) is detected.&quot;&quot;&quot;</span>
    <span class="n">num_obs</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;the number of &quot;good&quot; observations used for model estimation.&quot;&quot;&quot;</span>
    <span class="n">coefs</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;2-d array of shape (nbands, ncoefs) to keep multispectral harmonic coefficients from the last lasso regression. If not flexible mode, the spectral bands are fixed, including blue, green, red, nir, swir1, swir2 (from  row 1 to 6).If flexible mode, the rows follow the order of inputted bands.The columns are six harmonic coefficients including intercept, slope, cos_annual, sin_annual, cos_semi, sin_semi, (from col 1 to 6). Note the slope has been multiplied by 10000, S-CCD uses 6-coefs model and 6 spectral bands. &quot;&quot;&quot;</span>
    <span class="n">rmse</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;1-d array of shape (nbands,), multispectral RMSE of predicted and actiual observations.&quot;&quot;&quot;</span>
    <span class="n">magnitude</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;1-d array of shape (nbands,), multispectral median difference between model prediction and observations of a window of conse observations following detected breakpoint.&quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="nrtqueue">
<a class="viewcode-back" href="../../api/pyxccd.common.html#pyxccd.common.nrtqueue">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">nrtqueue</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;1-d array of structured type for queue modes (2/4/5). It was used to store the observations and the dates</span>
<span class="sd">    in the queue until the CCDC initialization condition is met.&quot;&quot;&quot;</span>

    <span class="n">clry</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;1-d array of shape (nbands, 1), multispectral clear observation&quot;&quot;&quot;</span>
    <span class="n">clrx_since1982</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;the date number since 1982/7/16, equal to ordinal date - 723742&quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="nrtmodel">
<a class="viewcode-back" href="../../api/pyxccd.common.html#pyxccd.common.nrtmodel">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">nrtmodel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The sccd model for the monitoring modes (1/3/5/11), which allows NRT monitoring.&quot;&quot;&quot;</span>

    <span class="n">t_start_since1982</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Date number since 1982/7/16, equal to ordinal date - 723742. &quot;&quot;&quot;</span>
    <span class="n">num_obs</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Accumulated observation number for the current segment. &quot;&quot;&quot;</span>
    <span class="n">obs</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;2-d array of shape (nbands, nobs). The 6 spectral bands follow the order (blue, green, red, nir, swir1, swir2) for last 8 observations&quot;&quot;&quot;</span>
    <span class="n">obs_date_since1982</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;1-d array of shape (nobs,). The date number since 1982/7/16 for the last 8 observations. &quot;&quot;&quot;</span>
    <span class="n">covariance</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;2-d array of shape (nbands, ncofs_cov) | (nbands, n_cov_coefs). The covariance matrix for six bands (blue, green, red, nir, swir1, swir2). Each band has a 6*6 matrix as the covariance matrix</span>
<span class="sd">    was flatten into 1d. &quot;&quot;&quot;</span>
    <span class="n">nrt_coefs</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;2-d array of shape (nbands, ncoefs) | (nbands, ncoefs). Each row is for each spectral for six spectral bands (blue, green, red, nir, swir1, swir2). Each row has 6 coefficients for each band. &quot;&quot;&quot;</span>
    <span class="n">H</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;1-d array of shape (nbands,). Observation noise for six bands (blue, green, red, nir, swir1, swir2).&quot;&quot;&quot;</span>
    <span class="n">rmse_sum</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;1-d array of shape (nbands,). RMSE for six bands (blue, green, red, nir, swir1, swir2). &quot;&quot;&quot;</span>
    <span class="n">norm_cm</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The current normalized change magnitude for the last anomaly_conse spectral anomalies, multiplied by 100 and rounded. &quot;&quot;&quot;</span>
    <span class="n">cm_angle</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The included angle for the last anomaly_conse spectral anomalies, multiplied by 100 and rounded. &quot;&quot;&quot;</span>
    <span class="n">anomaly_conse</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">byte</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The current anomaly number at the tail of the time series. between 1 and 8. The anomalies were defined as the obs that are larger than anomaly_pcg. &quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="anomaly">
<a class="viewcode-back" href="../../api/pyxccd.common.html#pyxccd.common.anomaly">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">anomaly</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;anomaly segments as a structured array. S-CCD overdetected the spectral anomalies as &quot;anomalys&quot;</span>
<span class="sd">    using conse =3 and threshold=anomaly_pcg, which is used to trained a retrospective machine learning</span>
<span class="sd">    model for NRT scenario.&quot;&quot;&quot;</span>

    <span class="n">t_break</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ordinal date when the anomaly break is detected&quot;&quot;&quot;</span>
    <span class="n">coefs</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;2-d array of shape (nbands, ncoefs) to keep multispectral harmonic coefficients from the last lasso regression. Spectral bands include blue, green, red, nir, swir1, swir2, thermal (from row 1 to 7); eight harmonic coefficients include intercept, slope, cos_annual, sin_annual, cos_semi, sin_semi, cos_trimodal, sin_trimodal (from col 1 to 8). Note the slope has been multiplied by 10000.&quot;&quot;&quot;</span>
    <span class="n">obs</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;2-d array of shape (nbands, nobs). The 6 spectral bands follow the order (blue, green, red, nir, swir1, swir2) for last 8 observations.&quot;&quot;&quot;</span>
    <span class="n">obs_date_since1982</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;1-d array of shape (nobs,). The date number since 1982/7/16 for the last 8 observations. &quot;&quot;&quot;</span>
    <span class="n">norm_cm</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Normalized change magnitude for the last anomaly_conse spectral anomalies, multiplied by 100 and rounded. &quot;&quot;&quot;</span>
    <span class="n">cm_angle</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;included angale fot the last anomaly_conse spectral anomalies, multiplied by 100 and rounded. &quot;&quot;&quot;</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_update_nrt_model</span><span class="p">(</span><span class="n">nrt_model</span><span class="p">,</span> <span class="n">nbands</span><span class="p">,</span> <span class="n">ncoefs</span><span class="p">):</span>
    <span class="n">nrtmodel_dt_flex_new</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;t_start_since1982&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;num_obs&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;obs&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">,</span> <span class="p">(</span><span class="n">nbands</span><span class="p">,</span> <span class="n">SCCD_CONSE_OUTPUT</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;obs_date_since1982&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">,</span> <span class="n">SCCD_CONSE_OUTPUT</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;covariance&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="n">nbands</span><span class="p">,</span> <span class="n">ncoefs</span> <span class="o">*</span> <span class="n">ncoefs</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;nrt_coefs&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="n">nbands</span><span class="p">,</span> <span class="n">ncoefs</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">nbands</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;rmse_sum&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span> <span class="n">nbands</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;norm_cm&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;cm_angle&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;anomaly_conse&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ubyte</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="n">align</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">nrtmodel_dt_flex_new</span><span class="p">)</span>
    <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;t_start_since1982&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nrt_model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;t_start_since1982&quot;</span><span class="p">]</span>
    <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;num_obs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nrt_model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;num_obs&quot;</span><span class="p">]</span>
    <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;obs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nrt_model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;obs&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">nbands</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;obs_date_since1982&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nrt_model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;obs_date_since1982&quot;</span><span class="p">]</span>
    <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;covariance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nrt_model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;covariance&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">nbands</span><span class="p">,</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">ncoefs</span> <span class="o">*</span> <span class="n">ncoefs</span><span class="p">]</span>
    <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;nrt_coefs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nrt_model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;nrt_coefs&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">nbands</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">ncoefs</span><span class="p">]</span>
    <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;H&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nrt_model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;H&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">nbands</span><span class="p">]</span>
    <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;rmse_sum&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nrt_model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;rmse_sum&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">nbands</span><span class="p">]</span>
    <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;norm_cm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nrt_model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;norm_cm&quot;</span><span class="p">]</span>
    <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;cm_angle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nrt_model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;cm_angle&quot;</span><span class="p">]</span>
    <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;anomaly_conse&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nrt_model</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;anomaly_conse&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">tmp</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_update_nrtqueue</span><span class="p">(</span><span class="n">nrt_queue</span><span class="p">,</span> <span class="n">nbands</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nrt_queue</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">nrtqueue_dt_flex_new</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span>
        <span class="p">[(</span><span class="s2">&quot;clry&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">,</span> <span class="n">nbands</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;clrx_since1982&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">)],</span>
        <span class="n">align</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">nrtqueue_dt_flex_new</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;clrx_since1982&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nrt_queue</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;clrx_since1982&quot;</span><span class="p">]</span>
        <span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;clry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nrt_queue</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;clry&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">nbands</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">tmp</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_update_sccd_reccg</span><span class="p">(</span><span class="n">reccg</span><span class="p">,</span> <span class="n">nbands</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">ncoefs</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reccg</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">sccd_dt_flex_new</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;t_start&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;t_break&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;num_obs&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;coefs&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="n">nbands</span><span class="p">,</span> <span class="n">ncoefs</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;rmse&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">nbands</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;magnitude&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">nbands</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="n">align</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">sccd_dt_flex_new</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;t_start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reccg</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;t_start&quot;</span><span class="p">]</span>
        <span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;t_break&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reccg</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;t_break&quot;</span><span class="p">]</span>
        <span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;num_obs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reccg</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;num_obs&quot;</span><span class="p">]</span>
        <span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;coefs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reccg</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;coefs&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">nbands</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">ncoefs</span><span class="p">]</span>
        <span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;rmse&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reccg</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;rmse&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">nbands</span><span class="p">]</span>
        <span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;magnitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reccg</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;magnitude&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">nbands</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">tmp</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_update_cold_reccg</span><span class="p">(</span><span class="n">reccg</span><span class="p">,</span> <span class="n">nbands</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reccg</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="c1"># cold_dt_flex_new = numpy.dtype(</span>
    <span class="c1">#     [</span>
    <span class="c1">#         (&quot;t_start&quot;, numpy.int32),</span>
    <span class="c1">#         (&quot;t_break&quot;, numpy.int32),</span>
    <span class="c1">#         (&quot;num_obs&quot;, numpy.int32),</span>
    <span class="c1">#         (&quot;coefs&quot;, numpy.float32, (nbands, ncoefs)),</span>
    <span class="c1">#         (&quot;rmse&quot;, numpy.float32, nbands),</span>
    <span class="c1">#         (&quot;magnitude&quot;, numpy.float32,nbands),</span>
    <span class="c1">#     ],</span>
    <span class="c1">#     align=True,</span>
    <span class="c1"># )</span>
    <span class="n">cold_dt_flex_new</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;t_start&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;t_end&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;t_break&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;pos&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;num_obs&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;change_prob&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;coefs&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="n">nbands</span><span class="p">,</span> <span class="n">COLD_NUM_C</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;rmse&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">nbands</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;magnitude&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">nbands</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="n">tmp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cold_dt_flex_new</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;t_start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reccg</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;t_start&quot;</span><span class="p">]</span>
        <span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;t_end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reccg</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;t_end&quot;</span><span class="p">]</span>
        <span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;t_break&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reccg</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;t_break&quot;</span><span class="p">]</span>
        <span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;pos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reccg</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;pos&quot;</span><span class="p">]</span>
        <span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;num_obs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reccg</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;num_obs&quot;</span><span class="p">]</span>
        <span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;category&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reccg</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;category&quot;</span><span class="p">]</span>
        <span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;change_prob&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reccg</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;change_prob&quot;</span><span class="p">]</span>
        <span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;coefs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reccg</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;coefs&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">nbands</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">COLD_NUM_C</span><span class="p">]</span>
        <span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;rmse&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reccg</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;rmse&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">nbands</span><span class="p">]</span>
        <span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;magnitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reccg</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;magnitude&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">nbands</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">tmp</span>


<span class="c1"># def _update_cold_reccg(reccg, nbands, ncoefs):</span>
<span class="c1">#     n = len(reccg)</span>
<span class="c1">#     if n == 0:</span>
<span class="c1">#         return numpy.array([])</span>
<span class="c1">#     cold_dt_flex_new = numpy.dtype(</span>
<span class="c1">#         [</span>
<span class="c1">#             (&quot;t_start&quot;, numpy.int32),</span>
<span class="c1">#             (&quot;t_end&quot;, numpy.int32),</span>
<span class="c1">#             (&quot;t_break&quot;, numpy.int32),</span>
<span class="c1">#             (&quot;num_obs&quot;, numpy.int32),</span>
<span class="c1">#             (&quot;coefs&quot;, numpy.float32, (nbands, ncoefs)),</span>
<span class="c1">#             (&quot;rmse&quot;, numpy.float32, nbands),</span>
<span class="c1">#             (&quot;magnitude&quot;, numpy.float32,nbands),</span>
<span class="c1">#         ],</span>
<span class="c1">#         align=True,</span>
<span class="c1">#     )</span>
<span class="c1">#     tmp = numpy.zeros(shape=(n), dtype=sccd_dt_flex_new)</span>
<span class="c1">#     for i in range(n):</span>
<span class="c1">#         tmp[i][&quot;t_start&quot;] = reccg[i][&quot;t_start&quot;]</span>
<span class="c1">#         tmp[i][&quot;t_break&quot;] = reccg[i][&quot;t_break&quot;]</span>
<span class="c1">#         tmp[i][&quot;num_obs&quot;] = reccg[i][&quot;num_obs&quot;]</span>
<span class="c1">#         tmp[i][&quot;coefs&quot;] = reccg[i][&quot;coefs&quot;] [0:nbands, 0:ncoefs]</span>
<span class="c1">#         tmp[i][&quot;rmse&quot;] = reccg[i][&quot;rmse&quot;][0:nbands]</span>
<span class="c1">#         tmp[i][&quot;magnitude&quot;] = reccg[i][&quot;magnitude&quot;][0:nbands]</span>
<span class="c1">#     return tmp</span>


<div class="viewcode-block" id="update_anomaly">
<a class="viewcode-back" href="../../api/pyxccd.common.html#pyxccd.common.update_anomaly">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">update_anomaly</span><span class="p">(</span><span class="n">output_rec_cg_anomaly</span><span class="p">,</span> <span class="n">nbands</span><span class="p">,</span> <span class="n">ncoefs</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_rec_cg_anomaly</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">anomaly_dt_flex_new</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;t_break&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;coefs&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="n">nbands</span><span class="p">,</span> <span class="n">ncoefs</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;obs&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">,</span> <span class="p">(</span><span class="n">nbands</span><span class="p">,</span> <span class="n">SCCD_CONSE_OUTPUT</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;obs_date_since1982&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">,</span> <span class="n">SCCD_CONSE_OUTPUT</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;norm_cm&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">,</span> <span class="n">SCCD_CONSE_OUTPUT</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;cm_angle&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">short</span><span class="p">,</span> <span class="n">SCCD_CONSE_OUTPUT</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="n">align</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">anomaly_dt_flex_new</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;t_break&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_rec_cg_anomaly</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;t_break&quot;</span><span class="p">]</span>
        <span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;coefs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_rec_cg_anomaly</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;coefs&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">nbands</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">ncoefs</span><span class="p">]</span>
        <span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;obs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_rec_cg_anomaly</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;obs&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">nbands</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">SCCD_CONSE_OUTPUT</span><span class="p">]</span>
        <span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;obs_date_since1982&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_rec_cg_anomaly</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;obs_date_since1982&quot;</span><span class="p">][</span>
            <span class="mi">0</span><span class="p">:</span><span class="n">SCCD_CONSE_OUTPUT</span>
        <span class="p">]</span>
        <span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;norm_cm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_rec_cg_anomaly</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;norm_cm&quot;</span><span class="p">]</span>
        <span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;cm_angle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_rec_cg_anomaly</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;cm_angle&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">tmp</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Su Ye.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>